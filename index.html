<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gentle Warrior Universe</title>

  <style>
    :root{
      --bg1:#071f16; --bg2:#0b2d1e;
      --panel:#0f2c20; --muted:#b6c7b7; --accent:#9ae07a;
      --card-bg:rgba(255,255,255,0.03); --white:#fff;
      --radius:16px;
    }

    body{
      margin:0;
      font-family:system-ui, sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#dbeadf;
    }

    .wrap{max-width:980px;margin:24px auto;padding:0 18px}

    header.hero{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:22px;
      margin-bottom:18px;
      display:flex;
      align-items:center;
      gap:18px;
      justify-content:center;
    }

    .hero-avatar{
      width:96px;height:96px;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
    }

    .hero-avatar img{width:100%;height:100%;object-fit:cover}

    h1{margin:0;color:#fff;font-size:22px}
    .subtitle{color:var(--muted)}

    .tabs{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-bottom:18px;
    }

    .tab{
      padding:8px 16px;
      background:#062418;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }

    .tab.active{background:var(--accent);color:#063218}

    .panel{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:20px;
    }

    #gameBoard{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      max-width:400px;
      margin:0 auto;
    }

    .card{aspect-ratio:1;cursor:pointer;perspective:800px}

    .card-inner{
      width:100%;height:100%;
      transform-style:preserve-3d;
      transition:0.3s;
    }

    .card.flip .card-inner{transform:rotateY(180deg)}

    .card-front,.card-back{
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#07130e;
    }

    .card-front{background:url("card-back.png") center/cover no-repeat}

    .card-back{transform:rotateY(180deg)}

    .card-back img{width:70%;height:70%;object-fit:contain}

    .btn{
      background:var(--accent);
      border:none;
      border-radius:10px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
    }

    .leaderboard-box{
      margin-top:14px;
      background:rgba(255,255,255,0.04);
      padding:14px;
      border-radius:14px;
    }

    .leader-row{
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.05);
    }

    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:28px}
  </style>
</head>

<body>
<div class="wrap">
<header class="hero">
  <div class="hero-avatar">
    <img src="hero-portrait.jpg">
  </div>
  <div>
    <h1>Gentle Warrior Universe</h1>
    <div class="subtitle">Soft heart. Strong spirit.</div>
  </div>
</header>

<div class="tabs">
  <div class="tab active">Game</div>
</div>

<section class="panel">
<h2 style="text-align:center">Memory Game</h2>

<div style="text-align:center;">
  <input id="gw-player-name" placeholder="Your public name">
  <button id="gw-save-name" class="btn">Save name</button>
  <br><br>
  <button id="startBtn" class="btn">Start</button>
  <button id="resetBtn" class="btn">Reset</button>
  <div id="stats">Time: 00:00 • Moves: 0</div>
</div>

<div id="gameBoard"></div>

<div class="leaderboard-box">
  <strong>Weekly Leaderboard</strong>
  <div id="leaderboard">Loading leaderboard…</div>
</div>
</section>

<footer>Gentle Warrior • © 2025</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, setDoc, addDoc,
  updateDoc, serverTimestamp, query, orderBy, limit, getDocs
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDZQFN0iMQ1QvgY2ptRFuOKY1sTz9zZhb8",
  authDomain: "gentle-warrior.firebaseapp.com",
  projectId: "gentle-warrior",
  storageBucket: "gentle-warrior.firebasestorage.app",
  messagingSenderId: "206508766648",
  appId: "1:206508766648:web:3451e7dcd6c9008e9c8b4d"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const playersCol = collection(db, "players");
const runsCol = collection(db, "runs");

function isoWeekId(){
  const d = new Date();
  d.setHours(0,0,0,0);
  const day = d.getDay()||7;
  d.setDate(d.getDate()+4-day);
  const yearStart = new Date(d.getFullYear(),0,1);
  const weekNo = Math.ceil((((d-yearStart)/864e5)+1)/7);
  return `${d.getFullYear()}-${weekNo}`;
}

function getDevice(){
  let t = localStorage.getItem("gw_tag");
  if(!t){ t="gw_"+Math.random().toString(36).slice(2,9); localStorage.setItem("gw_tag",t);}
  return t;
}

async function recordRun(moves,time){
  const name = localStorage.getItem("gw_player_name")||"Warrior";
  const tag = getDevice();
  const season = isoWeekId();
  const pRef = doc(db,"players",tag);
  const snap = await getDoc(pRef);

  if(!snap.exists()){
    await setDoc(pRef,{name,tag,currentWeekMoves:moves,currentWeekTimeMs:time,currentSeasonId:season});
  } else {
    await updateDoc(pRef,{name,currentWeekMoves:moves,currentWeekTimeMs:time,currentSeasonId:season});
  }

  await addDoc(runsCol,{name,tag,moves,time,season,createdAt:serverTimestamp()});
  renderLeaderboard();
}

async function renderLeaderboard(){
  const box=document.getElementById("leaderboard");
  box.innerText="Loading leaderboard…";
  const season=isoWeekId();

  try{
    const q=query(playersCol,orderBy("currentWeekMoves"),limit(200));
    const snaps=await getDocs(q);

    const list=[];
    snaps.forEach(s=>{
      const d=s.data();
      if(d.currentSeasonId===season){
        list.push({name:d.name,moves:d.currentWeekMoves,time:d.currentWeekTimeMs});
      }
    });

    if(!list.length){box.innerText="No runs yet.";return;}

    box.innerHTML=list.slice(0,10).map((p,i)=>
      `<div class="leader-row"><div>#${i+1} ${p.name}</div><div>${p.moves} • ${Math.round(p.time/1000)}s</div></div>`
    ).join("");
  }catch(e){
    console.error(e);
    box.innerText="Unable to load leaderboard.";
  }
}

window.gwRecordRun = recordRun;
window.gwRenderLeaderboard = renderLeaderboard;

renderLeaderboard();
</script>
</body>
</html>
