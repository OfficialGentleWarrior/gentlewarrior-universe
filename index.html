<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gentle Warrior Universe</title>
<meta name="description" content="Gentle Warrior Memory Game & Weekly Leaderboard">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZLK6PBCQ7P"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZLK6PBCQ7P');
</script>

<style>
:root{
 --bg1:#071f16;--bg2:#0b2d1e;--panel:#0f2c20;--muted:#b6c7b7;--accent:#9ae07a;
}
body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e2f0e4;font-family:system-ui;}
.wrap{max-width:980px;margin:auto;padding:18px}
.panel{background:rgba(255,255,255,0.03);padding:18px;border-radius:16px;margin-bottom:16px}
header{display:flex;align-items:center;gap:16px}
header img{width:96px;border-radius:20px}
.tabs{display:flex;gap:8px;justify-content:center;margin:16px 0}
.tab-btn{padding:8px 16px;border-radius:999px;border:none;background:#062515;color:#dbeadf;font-weight:700}
.tab-btn.active{background:var(--accent);color:#04210f}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.symbol-card{background:#0a2419;border-radius:16px;padding:12px;text-align:center;cursor:pointer}
.symbol-card img{width:140px;border-radius:20px}
#controls{text-align:center;margin-bottom:8px}
#gw-player-name{padding:10px;border-radius:999px;border:none;background:#02140d;color:#fff}
.btn{padding:10px 18px;border-radius:999px;border:none;background:var(--accent);font-weight:700}
#gameBoard{max-width:460px;margin:auto;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.card{aspect-ratio:1/1;cursor:pointer}
.card-inner{width:100%;height:100%;transition:.3s;transform-style:preserve-3d}
.card.flip .card-inner{transform:rotateY(180deg)}
.card-front,.card-back{position:absolute;inset:0;border-radius:14px;backface-visibility:hidden;display:flex;align-items:center;justify-content:center}
.card-front{background:#081512 url(card-back.png) center/cover}
.card-back{transform:rotateY(180deg);background:#050f0a}
.card-back img{width:70%;filter:drop-shadow(0 0 8px gold)}
.leaderboard-box{background:rgba(255,255,255,0.04);border-radius:12px;padding:12px}
.leader-row{display:flex;justify-content:space-between;padding:4px 0}
footer{text-align:center;color:#96b6a4;margin:22px 0}
</style>
</head>

<body>
<div class="wrap">

<header class="panel">
  <img src="hero-portrait.jpg">
  <div>
    <h2>Gentle Warrior Universe</h2>
    <div>Soft heart. Strong spirit.</div>
  </div>
</header>

<div id="caBox" class="panel">Loading official CA…</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="home">Home</button>
  <button class="tab-btn" data-tab="symbols">Symbols</button>
  <button class="tab-btn" data-tab="game">Game</button>
</div>

<!-- HOME -->
<section id="home" class="panel">
<h3>Project Goal</h3>
<p>Gentle Warrior is inspired by a child’s fight against illness and the strength found in kindness.</p>
<ol>
 <li>Build a heart-centered brand</li>
 <li>Create stories & games</li>
 <li>Grow safely and responsibly</li>
 <li>Promote empathy</li>
 <li>Help children in need</li>
</ol>
</section>

<!-- SYMBOLS -->
<section id="symbols" class="panel" style="display:none">
<h3>The Six Symbols</h3>
<div class="grid">

<div class="symbol-card" data-name="Aurelion" data-lore="Light & leadership"><img src="symbol-aurelion.png"><div>Aurelion</div></div>
<div class="symbol-card" data-name="Gaialune" data-lore="Nature & healing"><img src="symbol-gaialune.png"><div>Gaialune</div></div>
<div class="symbol-card" data-name="Ignara" data-lore="Passion & will"><img src="symbol-ignara.png"><div>Ignara</div></div>
<div class="symbol-card" data-name="Solyndra" data-lore="Guidance & hope"><img src="symbol-solyndra.png"><div>Solyndra</div></div>
<div class="symbol-card" data-name="Umbrath" data-lore="Mystery & protection"><img src="symbol-umbrath.png"><div>Umbrath</div></div>
<div class="symbol-card" data-name="Zeratheon" data-lore="Strength & justice"><img src="symbol-zeratheon.png"><div>Zeratheon</div></div>

</div>
</section>

<!-- GAME -->
<section id="game" class="panel" style="display:none">
<h3>Memory Game — Weekly Challenge</h3>
<div id="countdown">Loading season timer…</div>

<div id="controls">
<input id="gw-player-name" placeholder="Your name">
<button id="gw-save-name" class="btn">Save</button>
</div>

<div style="text-align:center">
<button id="startBtn" class="btn">Start</button>
<button id="resetBtn" class="btn" style="background:#244">Reset</button>
</div>

<div id="stats" style="text-align:center;margin:8px">Time: 00:00 • Moves: 0</div>

<div id="gameBoard"></div>

<div class="leaderboard-box">
 <strong>Weekly Leaderboard</strong>
 <div id="leaderboard">Loading leaderboard...</div>
</div>
</section>

<footer>Gentle Warrior © 2025</footer>
</div>

<script>
// ---- TABS
document.querySelectorAll('.tab-btn').forEach(b=>{
 b.onclick=()=>{
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  ['home','symbols','game'].forEach(id=>{
   document.getElementById(id).style.display = id===b.dataset.tab?'block':'none';
  });
 };
});

// ---- SYMBOL MODAL
document.querySelectorAll('.symbol-card').forEach(c=>{
 c.onclick=()=>alert(c.dataset.name+"\n\n"+c.dataset.lore);
});

// ---- PLAYER NAME
const nameInput=document.getElementById("gw-player-name");
nameInput.value=localStorage.getItem("gw_player_name")||"Warrior";
document.getElementById("gw-save-name").onclick=()=>{
 localStorage.setItem("gw_player_name",nameInput.value||"Warrior");
 alert("Saved!");
};

// ---- COUNTDOWN
function getNextMondayUTC(){
 const now=new Date();
 const d=now.getUTCDay();
 let diff=(1-d+7)%7; if(diff===0)diff=7;
 return new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()+diff,0,0,0));
}
const nextMonday=getNextMondayUTC();
setInterval(()=>{
 const d=nextMonday-new Date();
 const s=Math.max(0,Math.floor(d/1000));
 const D=Math.floor(s/86400),H=Math.floor(s%86400/3600),M=Math.floor(s%3600/60),S=s%60;
 document.getElementById("countdown").textContent=`Next season: ${D}d ${H}h ${M}m ${S}s (UTC)`;
},1000);

// ---- GAME
const board=document.getElementById("gameBoard");
let deck=[],first=null,lock=false,moves=0,time=0,timer=null,started=false,matched=0;

function updateStats(){document.getElementById("stats").textContent=`Time: ${String(Math.floor(time/60)).padStart(2,'0')}:${String(time%60).padStart(2,'0')} • Moves: ${moves}`;}

function shuffle(a){for(let i=a.length-1;i;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}

function buildDeck(){
 const icons=["card-symbol-aurelion.png","card-symbol-gaialune.png","card-symbol-ignara.png","card-symbol-solyndra.png","card-symbol-umbrath.png","card-symbol-zeratheon.png"];
 deck=[];
 icons.forEach(i=>{deck.push(i,i)});
 shuffle(deck);
}

function render(){
 board.innerHTML="";
 deck.forEach(i=>{
  const c=document.createElement("div");c.className="card";
  c.innerHTML=`<div class="card-inner"><div class="card-front"></div><div class="card-back"><img src="${i}"></div></div>`;
  c.onclick=()=>flip(c,i);
  board.appendChild(c);
 });
}

function flip(c,img){
 if(lock||!started||c===first||c.classList.contains("flip"))return;
 c.classList.add("flip");
 if(!first){first=c;return;}
 moves++;updateStats();
 const a=first.querySelector("img").src;
 if(a===c.querySelector("img").src){
  matched++;first=null;lock=false;
  if(matched==6)win();
 }else{
  lock=true;
  setTimeout(()=>{
   c.classList.remove("flip");
   first.classList.remove("flip");
   first=null;lock=false;
  },600);
 }
}

function win(){
 clearInterval(timer);
 if(moves<6){alert("Runs under 6 moves ignored.");return;}
 if(window.gwRecordRun)gwRecordRun(moves,time*1000);
 alert("Complete!");
}

document.getElementById("startBtn").onclick=()=>{
 buildDeck();render();
 started=true;moves=0;matched=0;time=0;
 clearInterval(timer);timer=setInterval(()=>{time++;updateStats()},1000);
};
document.getElementById("resetBtn").onclick=()=>{
 clearInterval(timer);board.innerHTML="";started=false;first=null;updateStats();
};

updateStats();

// ---- CA
fetch("ca.html").then(r=>r.text()).then(t=>caBox.innerHTML=t||"Contract soon.").catch(()=>caBox.innerHTML="Contract soon.");
</script>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore,collection,doc,getDoc,addDoc,setDoc,updateDoc,where,query,getDocs,serverTimestamp }
from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyDZQFN0iMQ1QvgY2ptRFuOKY1sTz9zZhb8",
 authDomain:"gentle-warrior.firebaseapp.com",
 projectId:"gentle-warrior"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const players=collection(db,"players");

function device(){return localStorage.gw_id||(localStorage.gw_id="gw"+Math.random())}

// ⚠️ DO NOT TOUCH getSeasonID()
function season(){return getSeasonID();}

window.gwRecordRun=async(moves,time)=>{
 const id=device();
 const name=localStorage.getItem("gw_player_name")||"Warrior";
 const sid=season();
 const ref=doc(players,id);
 let snap=await getDoc(ref);

 if(!snap.exists()){
  await setDoc(ref,{name,device:id,currentSeasonId:sid,currentWeekMoves:moves,currentWeekTimeMs:time});
 }else{
  const d=snap.data();
  if(d.currentSeasonId!==sid||moves<d.currentWeekMoves||(moves===d.currentWeekMoves&&time<d.currentWeekTimeMs)){
   await updateDoc(ref,{name,currentSeasonId:sid,currentWeekMoves:moves,currentWeekTimeMs:time});
  }
 }
 loadLB();
};

async function loadLB(){
 const sid=season();
 const q=query(players,where("currentSeasonId","==",sid));
 const s=await getDocs(q);
 const arr=[];
 s.forEach(d=>arr.push(d.data()));
 arr.sort((a,b)=>a.currentWeekMoves-b.currentWeekMoves||a.currentWeekTimeMs-b.currentWeekTimeMs);
 const top=arr.slice(0,10);
 document.getElementById("leaderboard").innerHTML=
 top.length?top.map((p,i)=>`<div class="leader-row">#${i+1} ${p.name} • ${p.currentWeekMoves} moves • ${Math.round(p.currentWeekTimeMs/1000)}s</div>`).join(""):"No data yet.";
}

loadLB();
</script>

</body>
</html>
