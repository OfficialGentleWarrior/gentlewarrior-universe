<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gentle Warrior Universe</title>
  <meta name="description" content="Gentle Warrior symbols, hero, and memory mini-game with weekly leaderboard.">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZLK6PBCQ7P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-ZLK6PBCQ7P');
  </script>

  <style>
    :root{
      --bg1:#071f16; --bg2:#0b2d1e;
      --panel:#0f2c20; --muted:#b6c7b7; --accent:#9ae07a;
      --card-bg:rgba(255,255,255,0.03); --white:#fff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#dbeadf;
    }
    .wrap{max-width:980px;margin:24px auto;padding:0 18px}

    header.hero{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:22px;
      margin-bottom:18px;
      display:flex;
      align-items:center;
      gap:18px;
    }
    .hero-avatar{
      width:106px;height:106px;
      border-radius:24px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
      flex-shrink:0;
    }
    .hero-avatar img{width:100%;height:100%;object-fit:cover}
    .hero-title h1{margin:0;font-size:22px;color:#fff}
    .hero-title p{margin:6px 0 0;color:var(--muted);font-size:14px}

    .banner-warning{
      background:#0c2e21;
      border-radius:12px;
      padding:14px;
      margin-bottom:20px;
      border:1px solid rgba(255,255,255,0.05);
      font-size:15px;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:12px;
      justify-content:center;
      margin:16px 0 20px;
    }
    .tab-btn{
      padding:10px 22px;
      border-radius:999px;
      border:none;
      background:#061b13;
      color:var(--white);
      font-weight:600;
      cursor:pointer;
      font-size:15px;
      box-shadow:0 4px 10px rgba(0,0,0,0.4);
    }
    .tab-btn.active{
      background:var(--accent);
      color:#063015;
    }
    .tab-section{display:none;}
    .tab-section.active{display:block;}

    .panel{
      background:var(--card-bg);
      border-radius:14px;
      padding:18px;
      margin-bottom:20px;
      box-shadow:0 6px 20px rgba(0,0,0,0.4);
    }

    #gw-goal h3{margin-top:0;color:#bff6b6}

    /* Symbols grid */
    .symbols-title{
      text-align:center;
      font-size:24px;
      margin:0 0 18px;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:16px;
    }
    @media(max-width:640px){
      .grid{grid-template-columns:repeat(2,1fr);}
    }

    .symbol-card{
      width:100%;
      background:var(--panel);
      text-align:center;
      padding:18px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.05);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .symbol-thumb{
      width:140px;height:140px;
      border-radius:28px;
      background:#071612;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 26px rgba(0,0,0,0.75);
    }
    .symbol-thumb img{
      width:100%;height:100%;
      object-fit:cover;
      border-radius:24px;
      filter:drop-shadow(0 8px 18px rgba(0,0,0,0.9));
    }
    .symbol-name{font-weight:800;margin-top:4px;text-align:center}
    .symbol-desc{color:var(--muted);font-size:13px;text-align:center}

    /* Memory game */
    #countdown{
      margin-bottom:10px;
      font-size:14px;
      color:var(--muted);
      text-align:center;
    }
    #controls{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    #gw-player-name{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background:#03140f;
      color:#fff;
      min-width:190px;
    }
    .btn{
      padding:9px 16px;
      border:none;
      border-radius:999px;
      background:var(--accent);
      font-weight:800;
      color:#06200b;
      cursor:pointer;
    }
    #stats{text-align:center;margin-bottom:10px;color:var(--muted)}

    #gameBoard{
      width:100%;
      max-width:480px;
      margin:0 auto 12px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
    }

    .card{width:100%;aspect-ratio:1/1;perspective:800px;cursor:pointer}
    .card-inner{
      position:relative;
      width:100%;height:100%;
      transform-style:preserve-3d;
      transition:0.28s ease;
    }
    .card.flip .card-inner{transform:rotateY(180deg)}
    .card-front,.card-back{
      position:absolute;inset:0;
      backface-visibility:hidden;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card-front{
      background:#07130e url("card-back.png") center/cover no-repeat;
    }
    .card-back{
      background:#07130e;
      transform:rotateY(180deg);
    }
    .card-back img{
      width:70%;height:70%;
      object-fit:contain;
      filter:drop-shadow(0 0 12px rgba(255,180,0,0.7));
    }

    .leaderboard-box{
      margin-top:14px;
      padding:14px;
      background:rgba(0,0,0,0.32);
      border-radius:14px;
    }
    .leader-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:14px;
    }
    .leader-row{
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
      font-size:14px;
    }
    .leader-row:last-child{border-bottom:none}
    .leader-caption{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
    .last-week{
      margin-top:12px;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,0.1);
      font-size:13px;
    }

    /* Modal */
    .modal-bg{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.6);
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal{
      background:#0c1f16;
      padding:18px;
      border-radius:14px;
      width:100%;
      max-width:560px;
      border:1px solid rgba(255,255,255,0.05);
      color:#e6f0e6;
    }
    .modal h2{text-align:center;margin:0 0 10px}
    .modal .modal-body{
      display:flex;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap;
      justify-content:center;
    }
    .modal .img-wrap{
      flex:0 0 160px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal .modal-body img{
      width:160px;height:160px;object-fit:contain;
    }
    .modal .lore{
      flex:1;
      font-size:14px;
      color:var(--muted);
      line-height:1.4;
      min-width:200px;
    }
    .modal-close{
      margin-top:14px;
      padding:10px;
      background:var(--accent);
      text-align:center;
      border-radius:8px;
      font-weight:800;
      cursor:pointer;
      color:#06200b;
    }

    footer{
      text-align:center;
      margin-top:30px;
      font-size:13px;
      color:var(--muted);
    }
    .socials-footer{
      margin-top:10px;
      display:flex;
      gap:18px;
      justify-content:center;
      align-items:center;
    }
    .socials-footer img{
      width:24px;height:24px;
      display:block;
    }
  </style>
</head>
<body>
<div class="wrap">

  <header class="hero">
    <div class="hero-avatar">
      <img src="hero-portrait.jpg" alt="Gentle Warrior">
    </div>
    <div class="hero-title">
      <h1>Gentle Warrior Universe</h1>
      <p>Soft heart. Strong spirit.</p>
    </div>
  </header>

  <div class="banner-warning" id="caBox">
    $GWAR — the token behind the Gentle Warrior world. A gentle heart. A strong spirit. CA : LINK • BEWARE OF FAKE TOKENS
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="home">Home</button>
    <button class="tab-btn" data-tab="symbols">Symbols</button>
    <button class="tab-btn" data-tab="game">Game</button>
  </div>

  <!-- Home tab -->
  <section id="tab-home" class="tab-section active">
    <section id="gw-goal" class="panel">
      <h3>Gentle Warrior — Project Goal</h3>
      <p>Gentle Warrior is inspired by the journey of a small child who faced early medical challenges with a courage far bigger than his body.</p>
      <ol>
        <li>Build a positive, heart-centered brand.</li>
        <li>Create meaningful stories and experiences.</li>
        <li>Grow responsibly (NFT, token, community).</li>
        <li>Promote empathy.</li>
        <li>Support children with similar conditions.</li>
      </ol>
    </section>
  </section>

  <!-- Symbols tab -->
  <section id="tab-symbols" class="tab-section">
    <section class="panel">
      <h2 class="symbols-title">The Six Symbols</h2>
      <div class="grid">

        <div class="symbol-card" data-key="aurelion" data-file="symbol-aurelion.png">
          <div class="symbol-thumb"><img src="symbol-aurelion.png" alt="Aurelion"></div>
          <div class="symbol-name">Aurelion</div>
          <div class="symbol-desc">Light, leadership</div>
        </div>

        <div class="symbol-card" data-key="gaialune" data-file="symbol-gaialune.png">
          <div class="symbol-thumb"><img src="symbol-gaialune.png" alt="Gaialune"></div>
          <div class="symbol-name">Gaialune</div>
          <div class="symbol-desc">Nature, healing</div>
        </div>

        <div class="symbol-card" data-key="ignara" data-file="symbol-ignara.png">
          <div class="symbol-thumb"><img src="symbol-ignara.png" alt="Ignara"></div>
          <div class="symbol-name">Ignara</div>
          <div class="symbol-desc">Passion, will</div>
        </div>

        <div class="symbol-card" data-key="solyndra" data-file="symbol-solyndra.png">
          <div class="symbol-thumb"><img src="symbol-solyndra.png" alt="Solyndra"></div>
          <div class="symbol-name">Solyndra</div>
          <div class="symbol-desc">Guidance, hope</div>
        </div>

        <div class="symbol-card" data-key="umbrath" data-file="symbol-umbrath.png">
          <div class="symbol-thumb"><img src="symbol-umbrath.png" alt="Umbrath"></div>
          <div class="symbol-name">Umbrath</div>
          <div class="symbol-desc">Mystery, protection</div>
        </div>

        <div class="symbol-card" data-key="zeratheon" data-file="symbol-zeratheon.png">
          <div class="symbol-thumb"><img src="symbol-zeratheon.png" alt="Zeratheon"></div>
          <div class="symbol-name">Zeratheon</div>
          <div class="symbol-desc">Strength, swift justice</div>
        </div>

      </div>
    </section>
  </section>

  <!-- Game tab -->
  <section id="tab-game" class="tab-section">
    <section class="panel">
      <h2 style="text-align:center;margin-top:0">Memory Game — Weekly Challenge</h2>

      <div id="countdown">Next official weekly season starts in: …</div>

      <div id="controls">
        <input id="gw-player-name" placeholder="Your public name">
        <button id="gw-save-name" class="btn">Save</button>
      </div>
      <p style="text-align:center;font-size:12px;color:var(--muted);margin-top:-4px;margin-bottom:10px;">
        Use the SAME name every run so your best score stays under one identity.
      </p>

      <div style="display:flex;justify-content:center;gap:10px;margin-bottom:10px;">
        <button id="startBtn" class="btn">Start</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>

      <div id="stats">Time: 00:00 • Moves: 0</div>

      <div id="gameBoard"></div>

      <div class="leaderboard-box">
        <div class="leader-header">
          <strong>Weekly Leaderboard</strong>
          <span style="font-size:12px;color:var(--muted)">Season resets automatically every Monday (UTC).</span>
        </div>
        <div id="leaderboard" style="margin-top:8px;">Loading leaderboard…</div>
      </div>
    </section>
  </section>

  <footer>
    Gentle Warrior • © 2025
    <div class="socials-footer">
      <a href="https://x.com/GentleWarrior02" target="_blank" rel="noopener">
        <img src="icon-x.png" alt="X">
      </a>
      <a href="https://www.tiktok.com/@officialgentlewarrior" target="_blank" rel="noopener">
        <img src="icon-tiktok.png" alt="TikTok">
      </a>
      <a href="https://www.instagram.com/officialgentlewarrior" target="_blank" rel="noopener">
        <img src="icon-ig.png" alt="Instagram">
      </a>
      <a href="https://t.me/OfficialGentleWarriorHQ" target="_blank" rel="noopener">
        <img src="icon-telegram.png" alt="Telegram">
      </a>
    </div>
  </footer>
</div>

<!-- Main script: tabs, symbols, game, countdown, CA loader -->
<script>
  /* ---------- Tabs ---------- */
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-'+tab).classList.add('active');
    });
  });

  /* ---------- Contract address loader (ca.html) ---------- */
  fetch('ca.html')
    .then(r=>r.text())
    .then(t=>{
      document.getElementById('caBox').innerHTML =
        (t && t.trim()) ||
        'The official contract address will be posted here, on our X page, and on Telegram only. Stay cautious — beware of fake or scam tokens.';
    })
    .catch(()=>{
      document.getElementById('caBox').textContent =
        'The official contract address will be posted here, on our X page, and on Telegram only. Stay cautious — beware of fake or scam tokens.';
    });

  /* ---------- Symbol lore ---------- */
  const SYMBOL_LORE = {
    aurelion: {
      title: "Aurelion",
      lore: "Aurelion — the guiding dawn. It embodies leadership, gentle radiance, and the courage to lead by compassion. Those who carry the light of Aurelion stand to inspire and protect."
    },
    gaialune: {
      title: "Gaialune",
      lore: "Gaialune — the healing green. Guardian of growth, renewal, and nature’s quiet strength. Its touch mends wounds, soothes hearts, and roots communities together."
    },
    ignara: {
      title: "Ignara",
      lore: "Ignara — the ember of will. Passionate and fierce, Ignara fuels perseverance and steady willpower that shapes destiny more than force alone."
    },
    solyndra: {
      title: "Solyndra",
      lore: "Solyndra — the starlit guide. A beacon of hope and quiet counsel, Solyndra lights hidden paths and comforts those who travel through darkness."
    },
    umbrath: {
      title: "Umbrath",
      lore: "Umbrath — the shadow guardian. Keeper of mysteries and protective silence, Umbrath shields the vulnerable and turns uncertainty into thoughtful vigilance."
    },
    zeratheon: {
      title: "Zeratheon",
      lore: "Zeratheon — the swift thunder. A symbol of justice and decisive strength, Zeratheon acts when balance is threatened, moving with purpose to restore order."
    }
  };

  function showModal(title, html){
    const bg = document.createElement('div'); bg.className='modal-bg';
    const modal = document.createElement('div'); modal.className='modal';
    modal.innerHTML = `<h2>${title}</h2><div class="modal-body">${html}</div>`;
    const close = document.createElement('div'); close.className='modal-close'; close.textContent='Close';
    close.onclick = () => bg.remove();
    modal.appendChild(close);
    bg.appendChild(modal);
    document.body.appendChild(bg);
    bg.addEventListener('click', e=>{ if(e.target===bg) bg.remove(); });
  }

  document.querySelectorAll('.symbol-card').forEach(card=>{
    card.addEventListener('click', ()=>{
      const key = card.dataset.key;
      const file = card.dataset.file;
      const info = SYMBOL_LORE[key] || { title:key, lore:'' };
      const html = `
        <div class="img-wrap">
          <img src="${file}" alt="${info.title}">
        </div>
        <div class="lore">
          <strong>${info.title}</strong>
          <p style="margin-top:8px">${info.lore}</p>
        </div>`;
      showModal(info.title, html);
    }, { passive:true });
  });

  /* ---------- Weekly season id (KEEP THIS STABLE) ---------- */
  function getSeasonId(date){
    const d = date ? new Date(date) : new Date();
    const utc = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    const day = utc.getUTCDay() || 7; // Monday-based ISO week
    utc.setUTCDate(utc.getUTCDate() + 4 - day);
    const yearStart = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil(((utc - yearStart) / 86400000 + 1) / 7);
    return `${utc.getUTCFullYear()}-${String(weekNo).padStart(2,"0")}`;
  }

  /* ---------- Countdown to next Monday 00:00 UTC ---------- */
  const countdownEl = document.getElementById('countdown');
  function nextMondayUTC(){
    const now = new Date();
    const day = now.getUTCDay(); // 0=Sun
    const daysUntilMon = (8 - day) % 7 || 7; // next Monday
    const target = new Date(Date.UTC(
      now.getUTCFullYear(),
      now.getUTCMonth(),
      now.getUTCDate() + daysUntilMon,
      0,0,0,0
    ));
    return target;
  }
  const seasonStartTarget = nextMondayUTC();
  function updateCountdown(){
    const now = new Date();
    let diff = seasonStartTarget - now;
    if(diff <= 0){
      countdownEl.textContent = "New weekly season has started. Good luck, Warrior!";
      return;
    }
    const totalSeconds = Math.floor(diff / 1000);
    const d = Math.floor(totalSeconds / 86400);
    const h = Math.floor((totalSeconds % 86400) / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    countdownEl.textContent =
      `Next official weekly season starts in: ${d}d ${h}h ${m}m ${s}s (UTC)`;
  }
  updateCountdown();
  setInterval(updateCountdown, 1000);

  /* ---------- Memory game (12 cards) ---------- */
  const gameBoard = document.getElementById('gameBoard');
  let deck = [], first=null, second=null, lock=false, moves=0, matches=0, started=false, timer=null, seconds=0;

  function formatTime(s){
    const m = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${m}:${ss}`;
  }
  function updateStats(){
    document.getElementById('stats').textContent =
      `Time: ${formatTime(seconds)} • Moves: ${moves}`;
  }
  function startTimer(){
    if(!timer) timer = setInterval(()=>{ seconds++; updateStats(); },1000);
  }
  function stopTimer(){ clearInterval(timer); timer=null; }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function buildDeck(){
    const files = [
      "symbol-aurelion.png",
      "symbol-gaialune.png",
      "symbol-ignara.png",
      "symbol-solyndra.png",
      "symbol-umbrath.png",
      "symbol-zeratheon.png"
    ];
    deck = [];
    files.forEach(f=>{
      deck.push({file:f,id:Math.random()});
      deck.push({file:f,id:Math.random()});
    });
    shuffle(deck);
  }

  function renderBoard(){
    gameBoard.innerHTML = '';
    deck.forEach(card=>{
      const wrap = document.createElement('div'); wrap.className='card'; wrap.dataset.id = card.id;
      const inner = document.createElement('div'); inner.className='card-inner';
      const front = document.createElement('div'); front.className='card-front';
      const back = document.createElement('div'); back.className='card-back';
      const img = document.createElement('img'); img.src = card.file;
      back.appendChild(img);
      inner.appendChild(front);
      inner.appendChild(back);
      wrap.appendChild(inner);
      wrap.onclick = ()=>handleCard(wrap);
      gameBoard.appendChild(wrap);
    });
  }

  function resetBoardOnly(){
    buildDeck();
    renderBoard();
  }

  function handleCard(card){
    if(lock) return;
    if(card === first) return;
    card.classList.add('flip');
    if(!started){
      startGame(true); // reuse but keep deck
      return;
    }
    if(!first){ first = card; return; }
    second = card; lock=true; moves++; updateStats();
    const img1 = first.querySelector('.card-back img').src;
    const img2 = second.querySelector('.card-back img').src;
    if(img1 === img2){
      matches++;
      first.style.pointerEvents='none';
      second.style.pointerEvents='none';
      first = second = null; lock=false;
      if(matches === 6) setTimeout(()=>onWin(),320);
    } else {
      setTimeout(()=>{
        first.classList.remove('flip');
        second.classList.remove('flip');
        first = second = null; lock=false;
      }, 600);
    }
  }

  function startGame(fromClick){
    started = true;
    moves = 0; matches = 0; seconds = 0;
    stopTimer(); startTimer();
    if(!fromClick){
      buildDeck();
      renderBoard();
    }
    updateStats();
    gtag('event','game_start');
  }

  function resetGame(){
    stopTimer();
    started = false;
    moves = 0; matches = 0; seconds = 0;
    first = second = null; lock=false;
    resetBoardOnly();
    updateStats();
  }

  document.getElementById('startBtn').onclick = ()=>startGame(false);
  document.getElementById('resetBtn').onclick = resetGame;

  function onWin(){
    stopTimer();
    started = false;
    gtag('event','game_win',{moves,seconds});
    // Anti-cheat: ignore impossible perfect runs (<6 moves)
    if(moves < 6){
      alert('Runs under 6 moves are treated as invalid. Please play a normal round.');
      return;
    }
    if(window.gwRecordRun) window.gwRecordRun(moves, seconds*1000);
    if(window.gwRenderLeaderboard) window.gwRenderLeaderboard();
    showModal('You win!', `<div style="text-align:center"><strong>Time:</strong> ${formatTime(seconds)}<br><strong>Moves:</strong> ${moves}</div>`);
  }

  /* ---------- Name save ---------- */
  const nameInput = document.getElementById('gw-player-name');
  const saveBtn = document.getElementById('gw-save-name');

  (function preloadName(){
    const saved = localStorage.getItem('gw_player_name');
    if(saved) nameInput.value = saved;
    else nameInput.value = 'Warrior';
  })();

  saveBtn.addEventListener('click', ()=>{
    const val = (nameInput.value || '').trim() || 'Warrior';
    localStorage.setItem('gw_player_name', val);
    alert('Name saved as: ' + val);
  });

  // initial board
  resetBoardOnly();
  updateStats();
</script>

<!-- Firebase + leaderboard (module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    setDoc,
    addDoc,
    updateDoc,
    serverTimestamp,
    query,
    orderBy,
    limit,
    getDocs,
    where
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDZQFN0iMQ1QvgY2ptRFuOKY1sTz9zZhb8",
    authDomain: "gentle-warrior.firebaseapp.com",
    projectId: "gentle-warrior",
    storageBucket: "gentle-warrior.firebasestorage.app",
    messagingSenderId: "206508766648",
    appId: "1:206508766648:web:3451e7dcd6c9008e9c8b4d"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const playersCol = collection(db,"players");
  const runsCol    = collection(db,"runs");

  function getDeviceTag(){
    let t = localStorage.getItem("gw_device_tag");
    if(!t){
      t = "gw_" + Math.random().toString(36).slice(2,9);
      localStorage.setItem("gw_device_tag", t);
    }
    return t;
  }

  async function ensurePlayer(deviceTag, name){
    const pRef = doc(db,"players",deviceTag);
    const snap = await getDoc(pRef);
    if(!snap.exists()){
      await setDoc(pRef,{
        name,
        deviceTag,
        createdAt: serverTimestamp(),
        totalPoints: 0,
        currentWeekMoves: null,
        currentWeekTimeMs: null,
        currentSeasonId: window.getSeasonId(),
        lastPlayedAt: serverTimestamp()
      });
      return { pRef, data:null };
    } else {
      const data = snap.data();
      try{
        await updateDoc(pRef,{
          name,
          lastPlayedAt: serverTimestamp()
        });
      }catch(e){}
      return { pRef, data };
    }
  }

  async function recordRun(moves, timeMs){
    const deviceTag = getDeviceTag();
    const name = localStorage.getItem("gw_player_name") || "Warrior";
    const seasonId = window.getSeasonId();

    const { pRef, data } = await ensurePlayer(deviceTag, name);

    // log run
    try{
      await addDoc(runsCol,{
        deviceTag,
        playerName:name,
        moves,
        timeMs,
        seasonId,
        createdAt: serverTimestamp()
      });
    }catch(e){ console.warn("addDoc failed",e); }

    let prevSeasonId = data && data.currentSeasonId;
    let prevMoves = data && data.currentWeekMoves != null ? data.currentWeekMoves : null;
    let prevTime  = data && data.currentWeekTimeMs != null ? data.currentWeekTimeMs : null;

    if(prevSeasonId !== seasonId){
      prevMoves = null;
      prevTime  = null;
    }

    const isBetter =
      prevMoves === null ||
      moves < prevMoves ||
      (moves === prevMoves && timeMs < prevTime);

    if(isBetter){
      try{
        await updateDoc(pRef,{
          currentSeasonId: seasonId,
          currentWeekMoves: moves,
          currentWeekTimeMs: timeMs,
          name,
          lastPlayedAt: serverTimestamp()
        });
      }catch(e){ console.warn("updateDoc failed",e); }
    }

    await renderLeaderboard();
  }

  async function renderLeaderboard(){
    const lb = document.getElementById("leaderboard");
    if(!lb) return;
    lb.textContent = "Loading leaderboard…";

    const seasonId = window.getSeasonId();

    try{
      // current season
      const qRef = query(
        playersCol,
        where("currentSeasonId","==",seasonId),
        where("currentWeekMoves","!=",null),
        orderBy("currentWeekMoves","asc"),
        limit(200)
      );
      const snaps = await getDocs(qRef);
      let arr = [];
      snaps.forEach(s=>{
        const d = s.data();
        if(d.currentWeekMoves != null){
          arr.push({
            id: s.id,
            name: d.name || "Warrior",
            moves: d.currentWeekMoves,
            time: d.currentWeekTimeMs || 0
          });
        }
      });

      // previous season id (simple step back)
      const [yStr,wStr] = seasonId.split("-");
      let y = parseInt(yStr,10), w = parseInt(wStr,10);
      if(w>1) w--; else { y--; w = 52; }
      const prevSeasonId = `${y}-${String(w).padStart(2,"0")}`;

      const qPrev = query(
        playersCol,
        where("currentSeasonId","==",prevSeasonId),
        where("currentWeekMoves","!=",null),
        orderBy("currentWeekMoves","asc"),
        limit(200)
      );
      const prevSnaps = await getDocs(qPrev);
      let lastWeekArr = [];
      prevSnaps.forEach(s=>{
        const d = s.data();
        if(d.currentWeekMoves != null){
          lastWeekArr.push({
            id:s.id,
            name:d.name || "Warrior",
            moves:d.currentWeekMoves,
            time:d.currentWeekTimeMs || 0
          });
        }
      });

      // If no current scores yet, show previous week (so Restraint appears)
      if(arr.length === 0 && lastWeekArr.length > 0){
        arr = lastWeekArr.slice();
        lastWeekArr = []; // treat as current only
      }

      arr.sort((a,b)=> a.moves - b.moves || a.time - b.time);
      lastWeekArr.sort((a,b)=> a.moves - b.moves || a.time - b.time);

      if(!arr.length){
        lb.innerHTML = "<p>No runs recorded for this week yet. Be the first to claim the board.</p>";
        if(lastWeekArr.length){
          lb.innerHTML += "<div class='last-week'><strong>Last Week Winners</strong><br/>" +
            lastWeekArr.slice(0,3).map((p,i)=>
              `#${i+1} ${p.name} — ${p.moves} moves, ${Math.round(p.time/1000)}s`
            ).join("<br/>") + "</div>";
        }
        return;
      }

      const top3 = arr.slice(0,3);
      let html = "<div><strong>Current Top 3 (This Week)</strong><br/>";
      html += top3.map((p,i)=>
        `#${i+1} ${p.name} — ${p.moves} moves, ${Math.round(p.time/1000)}s`
      ).join("<br/>") + "</div>";

      if(arr.length > 3){
        html += "<div class='leader-caption' style='margin-top:10px;'>Full Top 10</div>";
        const top10 = arr.slice(0,10);
        html += top10.map((p,i)=>
          `<div class="leader-row"><div>#${i+1} ${p.name}</div><div>${p.moves} moves • ${Math.round(p.time/1000)}s</div></div>`
        ).join("");
      }

      if(lastWeekArr.length){
        html += "<div class='last-week'><strong>Last Week Winners</strong><br/>" +
          lastWeekArr.slice(0,3).map((p,i)=>
            `#${i+1} ${p.name} — ${p.moves} moves, ${Math.round(p.time/1000)}s`
          ).join("<br/>") + "</div>";
      }

      lb.innerHTML = html;

    }catch(e){
      console.warn("renderLeaderboard error",e);
      lb.textContent = "Unable to load leaderboard.";
    }
  }

  // Restore Restraint into current season if nothing yet (one-time helper)
  async function restoreRestraintIfNeeded(){
    const seasonId = window.getSeasonId();

    const qCurrent = query(
      playersCol,
      where("currentSeasonId","==",seasonId),
      where("currentWeekMoves","!=",null),
      limit(1)
    );
    const curSnap = await getDocs(qCurrent);
    if(!curSnap.empty) return; // current season already has entries

    const qRestraint = query(
      playersCol,
      where("name","==","Restraint"),
      where("currentWeekMoves","!=",null),
      limit(1)
    );
    const rSnap = await getDocs(qRestraint);
    if(rSnap.empty) return;

    const docSnap = rSnap.docs[0];
    const pRef = doc(db,"players",docSnap.id);
    try{
      await updateDoc(pRef,{
        currentSeasonId: seasonId
      });
    }catch(e){ console.warn("restoreRestraintIfNeeded update failed",e); }
  }

  window.gwRecordRun = recordRun;
  window.gwRenderLeaderboard = renderLeaderboard;

  await restoreRestraintIfNeeded();
  renderLeaderboard();
</script>
</body>
</html>
