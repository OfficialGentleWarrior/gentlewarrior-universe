<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gentle Warrior</title>

<style>
body{margin:0;font-family:sans-serif;background:#071f16;color:#dbeadf}
.wrap{max-width:980px;margin:auto;padding:18px}

.hero{display:flex;gap:14px;background:#0f2c20;padding:16px;border-radius:14px}
.hero img{width:78px;height:78px;border-radius:16px;object-fit:cover}
.hero h1{margin:0}
.hero p{margin:5px 0;color:#9acfb5}

.notice{background:#0c3224;padding:12px;border-radius:12px;margin:12px 0;font-size:14px}

/* Tabs */
.tabs{display:flex;gap:10px;justify-content:center;margin-bottom:10px}
.tab{padding:8px 14px;border-radius:999px;background:#06361f;color:white;cursor:pointer;font-size:14px}
.tab.active{background:#9ae07a;color:#07260f;font-weight:bold}

.panel{background:#0f2c20;padding:16px;border-radius:14px;margin-bottom:16px}

/* Symbols */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.symbol{text-align:center;cursor:pointer}
.symbol img{width:110px;height:110px;border-radius:20px;object-fit:cover;box-shadow:0 6px 16px rgba(0,0,0,0.6)}
.symbol p{color:#b6c7b7;margin:4px 0;font-size:13px}

/* Memory Game */
#gameBoard{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:420px;margin:10px auto}
.card{perspective:800px}
.inner{position:relative;width:100%;aspect-ratio:1;transition:.3s;transform-style:preserve-3d}
.face,.back{position:absolute;inset:0;border-radius:10px;backface-visibility:hidden;border:1px solid rgba(255,255,255,0.12)}
.face{background:#061a13}
.back{transform:rotateY(180deg);background:#061a13;display:flex;align-items:center;justify-content:center}
.back img{width:70%;height:70%;object-fit:contain}
.flip{transform:rotateY(180deg)}

.stats{text-align:center;padding:8px;font-size:14px;color:#9acfb5}

/* Leaderboard */
.lb{margin-top:12px;background:rgba(0,0,0,0.25);padding:12px;border-radius:12px}
.row{display:flex;justify-content:space-between;border-bottom:1px solid #123;padding:5px 0;font-size:14px}
.row:last-child{border-bottom:none}
#top3Box b{color:#bff6b6}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:50}
.modal{background:#0c261c;padding:18px;border-radius:14px;max-width:420px;width:100%;text-align:center}
.modal img{width:140px;height:140px;border-radius:16px;object-fit:cover;margin-bottom:8px}
.modal button{margin-top:10px;padding:8px 16px;border-radius:999px;border:none;background:#9ae07a;color:#07260f;font-weight:bold;cursor:pointer}

/* Footer */
footer{text-align:center;font-size:12px;color:#7aa;margin-top:20px}
</style>
</head>
<body>
<div class="wrap">

  <div class="hero">
    <img src="hero-portrait.jpg" alt="Gentle Warrior">
    <div>
      <h1>Gentle Warrior</h1>
      <p>Soft heart. Strong spirit.</p>
    </div>
  </div>

  <div class="notice" id="caBox">Loading official contract‚Ä¶</div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="home">Home</div>
    <div class="tab" data-tab="symbols">Symbols</div>
    <div class="tab" data-tab="game">Game</div>
  </div>

  <!-- HOME -->
  <div id="home" class="panel">
    <h3>Project Goal</h3>
    <p>Gentle Warrior is a story of resilience, innocence, and kindness ‚Äî inspired by a small child who fought big battles with a soft heart and a strong spirit.</p>
    <ul>
      <li>Build a positive, heart-centered brand.</li>
      <li>Create meaningful stories, art, and mini-games.</li>
      <li>Grow the ecosystem responsibly (NFT + token).</li>
      <li>Promote empathy and community-first values.</li>
      <li>Support children with similar conditions over time.</li>
    </ul>
  </div>

  <!-- SYMBOLS -->
  <div id="symbols" class="panel" style="display:none">
    <h3>The Six Symbols</h3>
    <div class="grid" id="symbolGrid"></div>
  </div>

  <!-- GAME -->
  <div id="game" class="panel" style="display:none">
    <h3>Memory Game ‚Äî Weekly Challenge</h3>

    <div id="countdown" style="font-size:13px;color:#cfe7d5;margin-bottom:8px;"></div>

    <div style="text-align:center;margin:8px 0;">
      <input id="nameBox" placeholder="Your X name (for leaderboard)"
             style="padding:6px 10px;border-radius:999px;border:1px solid #244d3a;background:#071810;color:#fff;min-width:220px;">
      <button onclick="saveName()" style="padding:6px 12px;border-radius:999px;border:none;background:#9ae07a;color:#07260f;font-weight:bold;cursor:pointer;margin-left:6px;">
        Save
      </button>
    </div>

    <div style="text-align:center;margin-bottom:6px;font-size:12px;color:#9acfb5;">
      Use the SAME name every run so your best score stays under one identity.
    </div>

    <div style="text-align:center;margin-bottom:8px;">
      <button onclick="startGame()" style="padding:6px 12px;border-radius:999px;border:none;background:#9ae07a;color:#07260f;font-weight:bold;cursor:pointer;margin-right:4px;">Start</button>
      <button onclick="resetGame()" style="padding:6px 12px;border-radius:999px;border:none;background:#163b2a;color:#cfe7d5;font-weight:bold;cursor:pointer;">Reset</button>
    </div>

    <div class="stats" id="stats">Time: 00s ‚Ä¢ Moves: 0</div>

    <div id="gameBoard"></div>

    <div class="lb">
      <div style="margin-bottom:6px;">
        <strong>Weekly Leaderboard</strong>
        <div style="font-size:12px;color:#9acfb5;">Season resets automatically every Monday (UTC).</div>
      </div>

      <div id="top3Box" style="font-size:13px;margin-bottom:8px;">
        <em>Top 3 for this week will appear here as people finish runs.</em>
      </div>

      <div id="leaderboard">Loading leaderboard‚Ä¶</div>

      <div id="lastWinners" style="margin-top:10px;font-size:12px;color:#b6c7b7;"></div>
    </div>
  </div>

  <footer>Gentle Warrior ‚Ä¢ ¬© 2025</footer>
</div>

<script>
// ===========================
// Tabs
// ===========================
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    const target = tab.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
    document.getElementById(target).style.display='block';
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
  });
});

// ===========================
// Symbols + Lore
// ===========================
const SYMBOLS = [
  ["Aurelion","symbol-aurelion.png","Light and leadership"],
  ["Gaialune","symbol-gaialune.png","Nature and healing"],
  ["Ignara","symbol-ignara.png","Will and passion"],
  ["Solyndra","symbol-solyndra.png","Guidance and hope"],
  ["Umbrath","symbol-umbrath.png","Protection and mystery"],
  ["Zeratheon","symbol-zeratheon.png","Justice and strength"]
];

const SYMBOL_LORE = {
  Aurelion: "Aurelion ‚Äî the guiding dawn. Light that leads gently instead of ruling by fear.",
  Gaialune: "Gaialune ‚Äî the quiet healer. Roots, renewal, and the courage to rest.",
  Ignara: "Ignara ‚Äî the ember of will. Fire that protects what matters most.",
  Solyndra: "Solyndra ‚Äî the starlit guide. Hope that appears when the path seems dark.",
  Umbrath: "Umbrath ‚Äî the shadow guardian. Watching from the edges, guarding the vulnerable.",
  Zeratheon: "Zeratheon ‚Äî the swift thunder. Justice that moves fast, but never cruel."
};

(function renderSymbols(){
  const grid = document.getElementById('symbolGrid');
  grid.innerHTML = SYMBOLS.map(([name,file,desc])=>`
    <div class="symbol" onclick="openLore('${name}','${file}')">
      <img src="${file}" alt="${name}">
      <div><strong>${name}</strong></div>
      <p>${desc}</p>
    </div>
  `).join('');
})();

function openLore(name, img){
  const lore = SYMBOL_LORE[name] || "";
  const html = `
    <div class="modal-bg" onclick="this.remove()">
      <div class="modal" onclick="event.stopPropagation()">
        <img src="${img}" alt="${name}">
        <h3>${name}</h3>
        <p style="font-size:14px;color:#cfe7d5;margin-top:6px;">${lore}</p>
        <button onclick="this.closest('.modal-bg').remove()">Close</button>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

// ===========================
// Memory Game
// ===========================
let deck = [];
let firstCard = null;
let lockBoard = false;
let seconds = 0;
let moves = 0;
let timerId = null;

const statsEl  = document.getElementById('stats');
const boardEl  = document.getElementById('gameBoard');
const nameBox  = document.getElementById('nameBox');

function formatStats(){
  statsEl.textContent = `Time: ${seconds}s ‚Ä¢ Moves: ${moves}`;
}

function startTimer(){
  if(timerId) return;
  timerId = setInterval(()=>{ seconds++; formatStats(); },1000);
}

function stopTimer(){
  clearInterval(timerId);
  timerId = null;
}

function buildDeck(){
  const files = SYMBOLS.map(s=>s[1]);
  deck = [];
  files.forEach(file=>{
    deck.push({file,id:Math.random()});
    deck.push({file,id:Math.random()});
  });
  deck.sort(()=>Math.random()-0.5);
}

function renderBoard(){
  boardEl.innerHTML = deck.map(card=>`
    <div class="card" data-id="${card.id}" onclick="flipCard(this)">
      <div class="inner">
        <div class="face"></div>
        <div class="back"><img src="${card.file}" alt=""></div>
      </div>
    </div>
  `).join('');
}

function startGame(){
  resetGame();
  buildDeck();
  renderBoard();
  startTimer();
}

function resetGame(){
  stopTimer();
  deck = [];
  firstCard = null;
  lockBoard = false;
  seconds = 0;
  moves = 0;
  formatStats();
  boardEl.innerHTML = "";
}

window.flipCard = function(card){
  if(lockBoard || card.classList.contains('open')) return;
  if(!timerId) startTimer();

  card.classList.add('open');
  card.querySelector('.inner').classList.add('flip');

  if(!firstCard){
    firstCard = card;
    return;
  }

  moves++;
  formatStats();
  lockBoard = true;

  const img1 = firstCard.querySelector('.back img').src;
  const img2 = card.querySelector('.back img').src;

  if(img1 === img2){
    // match
    setTimeout(()=>{
      firstCard = null;
      lockBoard = false;
      checkWin();
    }, 120);
  } else {
    // not match
    setTimeout(()=>{
      card.classList.remove('open');
      card.querySelector('.inner').classList.remove('flip');
      firstCard.classList.remove('open');
      firstCard.querySelector('.inner').classList.remove('flip');
      firstCard = null;
      lockBoard = false;
    }, 600);
  }
};

function checkWin(){
  const opened = boardEl.querySelectorAll('.card.open').length;
  if(opened === deck.length){
    stopTimer();
    const reason = validateRun(seconds, moves);
    if(reason){
      alert(
        "Run marked as PRACTICE only.\n\n" +
        reason + "\n\nYou can keep playing, but this time will NOT enter the leaderboard."
      );
    } else {
      localStorage.setItem('gw_last_win_ts', String(Date.now()));
      saveScore();
      alert("You cleared the board! Your run has been sent to the weekly leaderboard.");
    }
  }
}

// ===========================
// Anti-Cheat (client-side)
// ===========================
function validateRun(timeSec, moveCount){
  // Basic floor: game cannot be solved in under 10s in a legit way
  if(timeSec < 10){
    return "Too fast to be a fair memory run (under 10 seconds).";
  }
  // Must at least flip enough pairs
  if(moveCount < 6){
    return "Move count is too low to be a valid complete run.";
  }
  // Simple spam protection: at least 8 seconds between 'wins'
  const lastTs = parseInt(localStorage.getItem('gw_last_win_ts') || "0", 10);
  const now    = Date.now();
  if(now - lastTs < 8000){
    return "Runs are being finished too frequently. Please slow down between attempts.";
  }
  return "";
}

// ===========================
// Name handling
// ===========================
function saveName(){
  const v = (nameBox.value || '').trim();
  if(!v){
    alert("Please enter a name first.");
    return;
  }
  localStorage.setItem('gwname', v);
  alert("Name saved as: " + v);
}
nameBox.value = localStorage.getItem('gwname') || "";

// ===========================
// Season ID (DO NOT TOUCH)
// ===========================
function getSeasonID(){
let d=new Date()
let monday=new Date(d)
monday.setUTCDate(d.getUTCDate()-(d.getUTCDay()-1))
monday.setUTCHours(0,0,0,0)
return monday.toISOString().slice(0,10)
}

// Helper: previous season (last Monday)
function getPreviousSeasonID(){
  const cur = getSeasonID(); // "YYYY-MM-DD"
  const d = new Date(cur + "T00:00:00Z");
  d.setUTCDate(d.getUTCDate() - 7);
  return d.toISOString().slice(0,10);
}

// ===========================
// Firestore via REST
// ===========================
const PROJECT_ID = "gentle-warrior";
const RUNS_ENDPOINT =
  `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/runs`;

// Save score (only called after anti-cheat passes)
async function saveScore(){
  const name   = (nameBox.value || '').trim() || "Warrior";
  const season = getSeasonID();

  const body = {
    fields: {
      name:   { stringValue: name },
      moves:  { integerValue: String(moves) },
      time:   { integerValue: String(seconds) },
      season: { stringValue: season }
    }
  };

  try{
    await fetch(RUNS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
  }catch(e){
    console.warn("Failed to save run", e);
  }

  loadLeaderboard(); // refresh after save
}

// Load leaderboard + top3 + last week winners
async function loadLeaderboard(){
  const lbDiv   = document.getElementById('leaderboard');
  const top3Div = document.getElementById('top3Box');
  const lastDiv = document.getElementById('lastWinners');

  lbDiv.textContent   = "Loading leaderboard‚Ä¶";
  top3Div.innerHTML   = "<em>Loading this week's Top 3‚Ä¶</em>";
  lastDiv.textContent = "Loading last week's champions‚Ä¶";

  const seasonNow  = getSeasonID();
  const seasonPrev = getPreviousSeasonID();

  try{
    const res  = await fetch(RUNS_ENDPOINT);
    const data = await res.json();
    const docs = data.documents || [];

    const runs = docs.map(d=>{
      const f = d.fields || {};
      const name   = (f.name   && f.name.stringValue)   || "Warrior";
      const moves  = f.moves   ? parseInt(f.moves.integerValue || f.moves.stringValue || "0",10) : 0;
      const time   = f.time    ? parseInt(f.time.integerValue  || f.time.stringValue  || "0",10) : 0;
      const season = (f.season && f.season.stringValue) || "";
      return { name, moves, time, season };
    });

    // Current season
    const current = runs
      .filter(r=>r.season === seasonNow)
      .sort((a,b)=> a.moves - b.moves || a.time - b.time);

    if(current.length === 0){
      lbDiv.textContent   = "No runs recorded for this week yet. Be the first one to post a time.";
      top3Div.innerHTML   = "<em>Top 3 will appear once players complete valid runs.</em>";
    } else {
      // Top 10 full leaderboard
      lbDiv.innerHTML = current.slice(0,10).map((p,i)=>`
        <div class="row">
          <div>#${i+1} ${escapeHtml(p.name)}</div>
          <div>${p.moves} moves ‚Ä¢ ${p.time}s</div>
        </div>
      `).join('');

      // Top 3 summary
      const top3 = current.slice(0,3);
      top3Div.innerHTML = `
        <div><b>Current Top 3 (This Week)</b></div>
        ${
          top3.map((p,i)=>`<div>#${i+1} ${escapeHtml(p.name)} ‚Äî ${p.moves} moves, ${p.time}s</div>`).join("")
        }
      `;
    }

    // Last week champions
    const last = runs
      .filter(r=>r.season === seasonPrev)
      .sort((a,b)=> a.moves - b.moves || a.time - b.time)
      .slice(0,3);

    if(last.length === 0){
      lastDiv.textContent = "No recorded winners from last week yet.";
    } else {
      lastDiv.innerHTML = `
        <div><strong>Last Week's Champions</strong></div>
        ${
          last.map((p,i)=>`<div>üèÖ #${i+1} ${escapeHtml(p.name)} ‚Äî ${p.moves} moves, ${p.time}s</div>`).join("")
        }
      `;
    }

  }catch(e){
    console.warn("loadLeaderboard error", e);
    lbDiv.textContent   = "Unable to load leaderboard.";
    top3Div.innerHTML   = "<em>Unable to load Top 3.</em>";
    lastDiv.textContent = "Unable to load last week's results.";
  }
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

loadLeaderboard();

// ===========================
// Countdown to next Monday 00:00 UTC
// ===========================
function updateCountdown(){
  const out = document.getElementById('countdown');
  const now = new Date();

  const next = new Date(now);
  // Next Monday 00:00 UTC
  const day = now.getUTCDay(); // 0 = Sun, 1 = Mon
  const delta = (8 - day) % 7 || 7; // days until next Monday
  next.setUTCDate(now.getUTCDate() + delta);
  next.setUTCHours(0,0,0,0);

  const diff = Math.max(0, Math.floor((next - now)/1000));
  const d = Math.floor(diff/86400);
  const h = Math.floor(diff%86400/3600);
  const m = Math.floor(diff%3600/60);
  const s = diff%60;

  out.textContent = `Next official weekly season starts in: ${d}d ${h}h ${m}m ${s}s (UTC)`;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// ===========================
// CA loader (ca.html)
// ===========================
fetch("ca.html")
  .then(r=>r.text())
  .then(t=>{
    const trimmed = (t || "").trim();
    document.getElementById("caBox").innerHTML =
      trimmed || "The official contract address will be posted here, on X, and in Telegram only.";
  })
  .catch(()=>{
    document.getElementById("caBox").textContent =
      "The official contract address will be posted here, on X, and in Telegram only.";
  });

</script>
</body>
</html>
