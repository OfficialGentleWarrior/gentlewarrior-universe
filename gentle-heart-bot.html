<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gentle Heart — Bot</title>
  <style>
    :root {
      --bg: #0f3a2f;
      --card: #113a2f;
      --muted: #9aa89d;
      --accent: #e3f8df;
      --send-bg: #e8f6d9;
      --send-text: #0b3a2c;
    }
    html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:#07281f; color:var(--accent); }
    .app {
      max-width:420px;
      margin:18px auto;
      background:linear-gradient(180deg,var(--card),#0e3a31);
      border-radius:18px;
      padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
      min-height:calc(100vh - 36px);
      display:flex;
      flex-direction:column;
    }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px }
    .avatar { width:56px; height:56px; background:#0b5; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#023; font-weight:700; }
    h1 { margin:0; font-size:20px; color:#dff6e1 }
    main { flex:1; overflow:auto; padding:8px 2px; }
    .qa-error { background:rgba(255,255,255,0.03); border-radius:10px; padding:12px; margin:8px 0; color:var(--muted); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
    .qa-error strong { color:#fff; display:block; margin-bottom:6px; }
    .messages { display:flex; flex-direction:column; gap:10px; padding-bottom:28px; }
    .input-row {
      display:flex; gap:12px; align-items:center;
      padding:14px; margin-top:8px; background:transparent;
    }
    .input-field {
      flex:1;
      background:rgba(0,0,0,0.15);
      border-radius:28px;
      padding:12px 16px;
      color:var(--accent);
      border:1px solid rgba(255,255,255,0.02);
      outline:none;
      min-height:44px;
    }
    .send-btn {
      min-width:84px;
      height:44px;
      border-radius:22px;
      background:var(--send-bg);
      color:var(--send-text);
      border:none;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .send-btn:active { transform:translateY(1px) }
    footer { font-size:12px; color:var(--muted); text-align:center; padding:8px 0 20px 0; }
    /* ensure nothing overlays input area */
    .nonblocking { pointer-events:auto; }
    /* small responsive */
    @media (max-width:460px) {
      .app { margin:8px; border-radius:14px; padding:12px; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Gentle Heart bot">
    <header>
      <div class="avatar">GH</div>
      <div>
        <h1>Gentle Heart</h1>
        <div style="font-size:13px;color:var(--muted)">Your gentle companion</div>
      </div>
    </header>

    <main id="main">
      <!-- messages and QA load notices appear here -->
      <div id="messages" class="messages" aria-live="polite"></div>
      <!-- QA load container - non-blocking -->
      <div id="qa-notice-container"></div>
    </main>

    <div class="input-row" role="region" aria-label="chat input">
      <div style="flex:1">
        <div id="input" class="input-field" contenteditable="true" role="textbox" aria-multiline="true" aria-label="Say hello — ask gently" spellcheck="true">Say hello — ask gently</div>
      </div>
      <button id="sendBtn" class="send-btn" aria-label="Send">Send</button>
    </div>

    <footer>Bot only. For info & emotional support — not medical advice.</footer>
  </div>

  <!-- Inline JSON fallback: the loader will try this first -->
  <script id="qa-inline" type="application/json">
  {
    "greetings": [
      "Hello! I'm here to listen.",
      "Hi — what's on your mind today?"
    ],
    "fallback_hotlines": [
      "If you need urgent help, please contact local emergency services."
    ]
  }
  </script>

  <script>
    // Global QA store
    let qaData = null;

    // DOM refs
    const messages = document.getElementById('messages');
    const qaNoticeContainer = document.getElementById('qa-notice-container');
    const sendBtn = document.getElementById('sendBtn');
    const inputEl = document.getElementById('input');

    // Utility to append a message
    function addMessage(text, cls = '') {
      const el = document.createElement('div');
      el.textContent = text;
      el.style.background = 'rgba(255,255,255,0.02)';
      el.style.padding = '10px';
      el.style.borderRadius = '8px';
      el.style.color = 'var(--accent)';
      messages.appendChild(el);
      messages.scrollTop = messages.scrollHeight;
    }

    // Show QA load error in a non-blocking way (does NOT overlay input)
    function showQALoadError(reason) {
      qaNoticeContainer.innerHTML = ''; // clear previous
      const box = document.createElement('div');
      box.className = 'qa-error nonblocking';
      const title = document.createElement('strong');
      title.textContent = 'QA load problem';
      const p = document.createElement('div');
      p.textContent = "We couldn't load qa.json. The bot will still work with fallback data. Check console for details.";
      box.appendChild(title);
      box.appendChild(p);
      if (reason) {
        const small = document.createElement('div');
        small.style.marginTop = '8px';
        small.style.fontSize = '12px';
        small.style.color = 'var(--muted)';
        small.textContent = 'Reason: ' + reason;
        box.appendChild(small);
      }
      qaNoticeContainer.appendChild(box);
    }

    // Robust QA loader (tries inline first, then external file)
    async function loadQAJSON() {
      // 1. Try inline JSON first (most robust)
      try {
        const inline = document.getElementById('qa-inline');
        if (inline && inline.textContent && inline.textContent.trim()) {
          qaData = JSON.parse(inline.textContent);
          console.log('Loaded QA from inline JSON');
          return;
        }
      } catch (err) {
        console.error('Inline QA load error:', err);
        // continue to try external
      }

      // 2. Try external qa.json (relative path)
      try {
        const res = await fetch('./qa.json', {cache: "no-store"});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        qaData = await res.json();
        console.log('Loaded QA from qa.json');
      } catch (err) {
        console.error('External QA load error:', err);
        showQALoadError(err.message || String(err));
        // fallback to safe defaults (keep bot usable)
        qaData = { greetings: ["Hello!"], fallback_hotlines: [] };
      }
    }

    // sendMessage - uses qaData for canned replies when possible
    function sendMessage() {
      const text = inputEl.textContent.trim();
      if (!text || text === 'Say hello — ask gently') {
        // do subtle prompt if empty
        inputEl.textContent = '';
        inputEl.focus();
        return;
      }

      addMessage('You: ' + text);
      inputEl.textContent = '';
      // quick simulated reply using qaData
      try {
        if (qaData && qaData.greetings && /hi|hello|hey/i.test(text)) {
          const reply = qaData.greetings[0];
          setTimeout(() => addMessage('Gentle Heart: ' + reply), 350);
          return;
        } else {
          setTimeout(() => addMessage('Gentle Heart: I hear you. Tell me more.'), 500);
        }
      } catch (err) {
        console.error('Reply error', err);
        setTimeout(() => addMessage('Gentle Heart: I\'m here.'), 450);
      }
    }

    // Ensure input Enter key sends
    inputEl.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' && !ev.shiftKey) {
        ev.preventDefault();
        sendMessage();
      }
    });

    // Wire send button to sendMessage; defensive: remove any previous listeners
    (function wireSendButton() {
      // remove previous onclick if present
      sendBtn.onclick = null;
      sendBtn.addEventListener('click', sendMessage);
      // make sure it's focusable and accessible
      sendBtn.tabIndex = 0;
    })();

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadQAJSON();
      } catch (err) {
        console.error('Loader crash', err);
        showQALoadError('loader crash');
      }
      // Add an initial gentle greeting from the bot
      if (qaData && qaData.greetings && qaData.greetings[0]) {
        addMessage('Gentle Heart: ' + qaData.greetings[0]);
      } else {
        addMessage('Gentle Heart: Hello — I am here to listen.');
      }
    });

    // Safety: make sure nothing overlays bottom on resize
    window.addEventListener('resize', () => {
      // keep main area scrollable so input remains visible
      const main = document.getElementById('main');
      main.style.maxHeight = (window.innerHeight - 220) + 'px';
    });
  </script>
</body>
</html>
