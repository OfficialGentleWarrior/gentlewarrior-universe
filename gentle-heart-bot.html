<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gentle Heart</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#06442a">

<style>
:root{
  --emerald-900:#04331f;
  --emerald-800:#06442a;
  --emerald-700:#0b5b39;
  --emerald-600:#0e6e47;
  --emerald-500:#1aa667;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--emerald-900);}
.app{min-height:100vh;display:flex;justify-content:center;}
.chat-shell{width:100%;max-width:560px;display:flex;flex-direction:column;color:#fff}
.header{
  position:fixed;top:0;left:0;right:0;
  max-width:560px;margin:auto;
  padding:14px 16px;
  display:flex;align-items:center;gap:12px;
  background:linear-gradient(180deg,var(--emerald-800),var(--emerald-700));
  z-index:1000;
}
.header img{width:40px;height:40px;border-radius:10px}
.title{font-weight:700}
.subtitle{font-size:12px;opacity:.8}
.user-area{margin-left:auto;display:flex;align-items:center;gap:10px}
.user-avatar{width:34px;height:34px;border-radius:50%;border:2px solid rgba(255,255,255,.6);object-fit:cover}
.settings-btn{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
.messages{
  flex:1;padding:84px 16px 16px;
  display:flex;flex-direction:column;gap:12px;overflow:auto
}
.msg{display:flex;gap:8px}
.msg.bot{justify-content:flex-start}
.msg.user{justify-content:flex-end}
.avatar{width:26px;height:26px;border-radius:50%}
.bubble{padding:8px 12px;border-radius:14px;max-width:75%;white-space:pre-wrap}
.msg.bot .bubble{background:linear-gradient(180deg,var(--emerald-700),var(--emerald-600))}
.msg.user .bubble{background:#fff;color:#04331f}
.input-bar{display:flex;gap:8px;padding:12px;position:sticky;bottom:0;background:#04331f}
.input-bar input{flex:1;padding:12px;border-radius:999px;border:0}
.input-bar button{padding:12px 16px;border-radius:999px;border:0;background:#1aa667;font-weight:600}
.settings-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
.hidden{display:none}
.settings-panel{background:#04331f;padding:18px;border-radius:14px;width:90%;max-width:320px}
.settings-panel h3{
  margin-top:0;
  margin-bottom:12px;
}

.setting-item{
  margin-bottom:14px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

.setting-item label{
  font-size:14px;
}

.setting-item small{
  font-size:12px;
  opacity:.75;
}

.settings-panel select{
  padding:8px;
  border-radius:8px;
  border:0;
  background:#0b5b39;
  color:#fff;
}

.settings-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}

.settings-actions button{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:0;
  background:#1aa667;
  font-weight:600;
}
</style>
</head>

<body>
<div class="app">
<div class="chat-shell">

<div class="header">
  <img src="avatar.png">
  <div>
    <div class="title">Gentle Heart</div>
    <div class="subtitle">Your gentle companion</div>
  </div>
  <div class="user-area">
    <label>
      <input type="file" id="userAvatarInput" hidden>
      <img id="userAvatarPreview" class="user-avatar" src="user-default.png">
    </label>
    <button id="settingsBtn" class="settings-btn">⚙️</button>
  </div>
</div>

<div id="messages" class="messages"></div>

<form id="chatForm" class="input-bar">
  <input id="userInput" placeholder="Say something…">
  <button>Send</button>
</form>

</div>
</div>

<div id="settingsModal" class="settings-modal hidden">
  <div class="settings-panel">
    <h3>Settings</h3>

    <!-- Kids Mode -->
    <div class="setting-item">
      <label>
        <input type="checkbox" id="kidsMode">
        Kids mode
      </label>
      <small>Simple and kid-friendly replies</small>
    </div>

    <!-- Country -->
    <div class="setting-item">
      <label for="countrySelect">Country</label>
      <select id="countrySelect">
        <option value="PH">Philippines</option>
        <option value="INT">International</option>
      </select>
    </div>

    <!-- Private Mode -->
    <div class="setting-item">
      <label>
        <input type="checkbox" id="privateMode">
        Private mode
      </label>
      <small>Do not save chat history</small>
    </div>

    <div class="settings-actions">
      <button id="clearHistoryBtn">Clear chat</button>
      <button id="closeSettingsBtn">Close</button>
    </div>
  </div>
</div>

<script>
const messagesEl = document.getElementById("messages");
const form = document.getElementById("chatForm");
const input = document.getElementById("userInput");

const settingsModal = document.getElementById("settingsModal");
const settingsBtn = document.getElementById("settingsBtn");
const closeSettingsBtn = document.getElementById("closeSettingsBtn");
const clearHistoryBtn = document.getElementById("clearHistoryBtn");

const privateModeCheckbox = document.getElementById("privateMode");

const userAvatarInput = document.getElementById("userAvatarInput");
const userAvatarPreview = document.getElementById("userAvatarPreview");

let history=JSON.parse(localStorage.getItem("gh_history")||"[]");
let QA=null;
let currentState=null;
let language="en";
let privateMode=false;

function detectLanguage(t){
  return /(ako|mo|ka|pakiramdam|nararamdaman|emosyon|kumusta|gutom|pagod|mabigat|magaan|tulog|hinga|ko|kamusta|matamis)/i.test(t)
    ? "tl" : "en";
}

fetch("./qa.json",{cache:"no-store"}).then(r=>r.json()).then(d=>{
  QA=d;
  currentState=QA.start;
  if(history.length) render();
  else botSpeak();
});

function render(){
  messagesEl.innerHTML="";
  history.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+m.role;
    d.innerHTML=m.role==="bot"
      ? `<img src="avatar.png" class="avatar"><div class="bubble">${m.text}</div>`
      : `<div class="bubble">${m.text}</div>`;
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function add(role,text){
  history.push({role,text});
  if(!privateMode) localStorage.setItem("gh_history",JSON.stringify(history));
  render();
}

function botSpeak(){
  if(!QA || !QA.states || !QA.states[currentState]) {
    add("bot", language==="tl" ? "Narito lang ako." : "I’m here with you.");
    return;
  }
  const s=QA.states[currentState];
  add("bot",s.text[language]||s.text.en);
}

/* ===============================
   GLOBAL ROUTER — 30 CATEGORIES
   =============================== */
const GLOBAL_ROUTES = [
{state:"mood_01",keywords:["mood","pakiramdam","feeling","feelings","nararamdaman","emotion","emotions","emosyon","how are you","kumusta","okay","okay ba","okay lang","not okay","hindi okay","heavy","mabigat","light","magaan","empty","parang walang laman","down","low","malungkot","good mood","magandang pakiramdam","bad mood","masamang pakiramdam"]},

{state:"food_01",keywords:["food","pagkain","eat","eating","kain","hungry","gutom","dessert","panghimagas","snack","meryenda","lunch","tanghalian","dinner","hapunan","breakfast","almusal","sweets","matamis","salty","maalat","viand","ulam","drinks","inumin"]},

{state:"genz_01",keywords:["genz","gen z","slang","salitang kalye","vibes","vibe","vibe check","check ng vibe","slay","astig","bet","trip","lowkey","patago","highkey","halata","rizz","dating","flex","yabang","cringe","nakakaasiwa","sus","kaduda-duda","iykyk","alam mo na","lit","solid","bussin","masarap","panalo"]},

{state:"hobby_01",keywords:["hobby","hobbies","libangan","free time","bakanteng oras","interests","interes","pastime","pinagkakaabalahan","talent","talento","skills","kakayahan","what you do","ginagawa mo","things you enjoy","trip mo"]},

{state:"crush_01",keywords:["crush","like someone","gusto ko","have feelings","may gusto","love","mahal","relationship","relasyon","dating","ligawan","courtship","ligaw","confess","umamin","heartbreak","wasak ang puso","feelings for someone","feelings sa tao"]},

{state:"cp_overview_01",keywords:["cerebral palsy","cp overview","overview ng cp","about cp","tungkol sa cp","what is cp","ano ang cp","cp basics","basics ng cp","cp info","impormasyon sa cp","cp condition","kondisyon ng cp"]},

{state:"cp_signs_01",keywords:["cp signs","palatandaan ng cp","symptoms","sintomas","delayed movement","delayed na galaw","delayed development","difficulty moving","hirap gumalaw","stiff muscles","matigas ang kalamnan","spastic"]},

{state:"cp_therapy_01",keywords:["therapy","physical therapy","occupational therapy","speech therapy","rehab","rehabilitasyon","exercises","ehersisyo","therapy session"]},

{state:"care_01",keywords:["care tips","tips sa pag-aalaga","caregiving","pag-aalaga","daily care","araw-araw na alaga","routine care","routine na pag-aalaga","support care","suportang pag-aalaga","how to care","paano alagaan"]},

{state:"emotional_support_01",keywords:["emotional support","emosyonal na suporta","comfort","aliw","need someone to talk to","kailangan kausap","someone listening","may makikinig ba","need help","kailangan ng tulong","lonely","nag-iisa"]},

{state:"family_01",keywords:["family","pamilya","parents","magulang","mother","nanay","father","tatay","siblings","kapatid","relatives","kamag-anak","family help","tulong ng pamilya"]},

{state:"daily_life_01",keywords:["daily life","araw-araw na buhay","routine","everyday life","pang-araw-araw","normal day","normal na araw","schedule","iskedyul"]},

{state:"medical_01",keywords:["medical","medikal","doctor","doktor","medicine","gamot","diagnosis","diagnosis","checkup","checkup","hospital","ospital","prescription","reseta","treatment","gamutan"]},

{state:"anxiety_01",keywords:["anxiety","anxiety","anxious","balisa","stress","stress","panic","panic","panic attack","panic attack","nervous","nerbyos","overwhelmed","napupuno","burnout","burnout"]},

{state:"sleep_01",keywords:["sleep","tulog","sleepy","antok","insomnia","insomnia","can’t sleep","hindi makatulog","trouble sleeping","hirap matulog","rest","pahinga","lack of sleep","puyat"]},

{state:"hotline_01",keywords:["hotline","hotline","emergency","emergency","crisis","krisis","help line","linya ng tulong","suicide hotline","suicide hotline","urgent help","agarang tulong"]},

{state:"cp_meaning_01",keywords:["meaning of cp","ibig sabihin ng cp","cp definition","kahulugan ng cp","what is cerebral palsy","ano ang cerebral palsy"]},

{state:"cp_specifics_01",keywords:["types of cp","uri ng cp","spastic cp","spastic cp","athetoid cp","athetoid cp","severity","tindi","mild cp","mild na cp","severe cp","malubhang cp","classification","klasipikasyon"]},

{state:"parenting_cp_01",keywords:["parenting cp","parenting ng may cp","raising a child with cp","pagpapalaki ng may cp","cp parent","magulang ng cp child","how to care for child","paano mag-alaga ng anak"]},

{state:"social_01",keywords:["social support","suportang panlipunan","friends","kaibigan","community","komunidad","support group","support group","social life","buhay panlipunan","someone to talk to","may kausap"]},

{state:"casual_01",keywords:["casual chat","chat lang","fun","saya","random chat","random na usap","small talk","kwentuhan","chill","chill"]},

{state:"rant_01",keywords:["rant","rant","complain","reklamo","angry","galit","annoyed","inis","frustrated","bwisit","vent","maglabas ng sama ng loob"]},

{state:"friendly_01",keywords:["hello","hi","hey","kumusta","how are you","friendly","palakaibigan","greetings","bati","good morning","magandang umaga","good evening","magandang gabi"]},

{state:"kids_01",keywords:["kids","bata","child","bata","kid safe","ligtas sa bata","simple explanation","simpleng paliwanag","easy to understand","madaling intindihin"]},

{state:"bot_intro_01",keywords:["who are you","sino ka","what are you","ano ka","are you a bot","bot ka ba","what can you do","anong kaya mo","limits","limitasyon","rules","patakaran"]},

{state:"language_01",keywords:["language","wika","tagalog","tagalog","english","english","filipino","filipino","change language","palitan ang wika"]},

{state:"settings_01",keywords:["settings","settings","options","mga option","privacy","privacy","private mode","private mode","kids mode","kids mode","clear history","burahin ang chat","reset chat","i-reset ang chat"]},

{state:"grounding_01",keywords:["grounding","grounding","breathing","paghinga","inhale","hinga papasok","exhale","hinga palabas","calm down","kumalma","relax","mag-relax","focus","mag-focus"]},

{state:"encourage_01",keywords:["encouragement","pampalakas-loob","affirmations","affirmations","you got this","kaya mo yan","stay strong","magpakatatag","hope","pag-asa","motivation","motibasyon"]},

{state:"fallback_01",keywords:["i don’t understand","di ko gets","not clear","di malinaw","confused","nalilito","clarify","linawin","repeat","ulit","what do you mean","ano ibig sabihin"]}
];

function resolveNextState(t){
  if(!QA || !QA.states || !currentState) return currentState;

  t = t.toLowerCase();
  const s = QA.states[currentState];

  if(s && s.options){
    for(const o of Object.values(s.options)){
      for(const k of o.keywords||[]){
        if(t.includes(k.toLowerCase())) return o.next;
      }
    }
  }

  for(const r of GLOBAL_ROUTES){
    for(const k of r.keywords){
      if(t.includes(k.toLowerCase())) return r.state;
    }
  }

  return currentState;
}

form.onsubmit=e=>{
  e.preventDefault();
  const t=input.value.trim();
  if(!t)return;
  input.value="";
  add("user",t);
  language=detectLanguage(t);
  currentState=resolveNextState(t);
  setTimeout(botSpeak,400);
};

settingsBtn.onclick=()=>settingsModal.classList.remove("hidden");
closeSettingsBtn.onclick=()=>settingsModal.classList.add("hidden");
clearHistoryBtn.onclick=()=>{history=[];localStorage.removeItem("gh_history");render();}
privateModeCheckbox.onchange = e => {
  privateMode = e.target.checked;
};

userAvatarInput.onchange=()=>{
  const f=userAvatarInput.files[0];
  const r=new FileReader();
  r.onload=()=>{userAvatarPreview.src=r.result;localStorage.setItem("userAvatar",r.result);}
  r.readAsDataURL(f);
}
const saved=localStorage.getItem("userAvatar");
if(saved) userAvatarPreview.src=saved;
</script>
</body>
</html>
