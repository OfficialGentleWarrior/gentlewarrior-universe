<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gentle Heart</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#06442a">

<style>
:root{
  --emerald-900:#04331f;
  --emerald-800:#06442a;
  --emerald-700:#0b5b39;
  --emerald-600:#0e6e47;
  --emerald-500:#1aa667;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--emerald-900);color:#fff}

.app{min-height:100vh;display:flex;justify-content:center}
.chat-shell{width:100%;max-width:560px;display:flex;flex-direction:column}

.header{
  position:fixed;top:0;left:0;right:0;
  max-width:560px;margin:auto;
  padding:12px 16px;
  display:flex;align-items:center;gap:10px;
  background:linear-gradient(180deg,var(--emerald-800),var(--emerald-700));
  z-index:1000;
}
.header img{width:40px;height:40px;border-radius:10px}
.title{font-weight:700}
.subtitle{font-size:12px;opacity:.8}
.user-area{margin-left:auto;display:flex;align-items:center;gap:10px}
.user-avatar{width:34px;height:34px;border-radius:50%;border:2px solid rgba(255,255,255,.6);object-fit:cover}
.settings-btn{background:none;border:none;color:#fff;font-size:20px}

.messages{
  flex:1;
  padding:84px 16px 16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:auto;
}

.msg{display:flex;gap:8px}
.msg.bot{justify-content:flex-start}
.msg.user{justify-content:flex-end}
.avatar{width:26px;height:26px;border-radius:50%}
.bubble{padding:10px 14px;border-radius:16px;max-width:75%;white-space:pre-wrap}
.msg.bot .bubble{background:linear-gradient(180deg,var(--emerald-700),var(--emerald-600))}
.msg.user .bubble{background:#fff;color:#04331f}

.typing{opacity:.8;font-size:14px;padding:6px 10px}

.input-bar{
  display:flex;gap:8px;padding:12px;
  position:sticky;bottom:0;background:#04331f
}
.input-bar input{flex:1;padding:12px;border-radius:999px;border:0}
.input-bar button{
  padding:12px 16px;border-radius:999px;border:0;
  background:#1aa667;font-weight:600
}

/* SETTINGS */
.settings-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:flex;align-items:center;justify-content:center
}
.hidden{display:none}
.settings-panel{
  background:#04331f;padding:18px;border-radius:14px;
  width:90%;max-width:320px
}
.settings-panel h3{margin-top:0}
.settings-panel label{display:block;margin:10px 0}
.settings-actions{display:flex;gap:10px;margin-top:14px}
.settings-actions button{
  flex:1;padding:10px;border-radius:10px;border:0;
  background:#1aa667;font-weight:600
}
</style>
</head>

<body>
<div class="app">
<div class="chat-shell">

<div class="header">
  <img src="avatar.png">
  <div>
    <div class="title">Gentle Heart</div>
    <div class="subtitle">Your gentle companion</div>
  </div>
  <div class="user-area">
    <label>
      <input type="file" id="avatarInput" hidden>
      <img id="userAvatar" class="user-avatar" src="user-default.png">
    </label>
    <button id="settingsBtn" class="settings-btn">⚙️</button>
  </div>
</div>

<div id="messages" class="messages"></div>

<form id="chatForm" class="input-bar">
  <input id="userInput" placeholder="Say something…">
  <button>Send</button>
</form>

</div>
</div>

<div id="settingsModal" class="settings-modal hidden">
  <div class="settings-panel">
    <h3>Settings</h3>
    <label><input type="checkbox" id="kidsMode"> Kids mode</label>
    <label><input type="checkbox" id="privateMode"> Private mode</label>
    <label>
      Country
      <select id="countrySelect">
        <option value="PH">Philippines</option>
        <option value="INT">International</option>
      </select>
    </label>
    <div class="settings-actions">
      <button id="clearBtn" type="button">Clear chat</button>
      <button id="closeSettings" type="button">Close</button>
    </div>
  </div>
</div>

<script>
const messagesEl=document.getElementById("messages");
const input=document.getElementById("userInput");
const form=document.getElementById("chatForm");

const settingsBtn=document.getElementById("settingsBtn");
const settingsModal=document.getElementById("settingsModal");
const closeSettings=document.getElementById("closeSettings");
const clearBtn=document.getElementById("clearBtn");
const privateModeCheckbox=document.getElementById("privateMode");

const avatarInput=document.getElementById("avatarInput");
const userAvatar=document.getElementById("userAvatar");

let QA=null;
let currentState=null;
let history=JSON.parse(localStorage.getItem("gh_history")||"[]");
let privateMode=false;
let language="en";

/* LANGUAGE */
function detectLanguage(t){
  return /(kumusta|pakiramdam|nararamdaman|emosyon|gutom|mabigat|magaan|antok|pahinga|matamis)/i.test(t)
    ? "tl":"en";
}

/* RENDER */
function render(){
  messagesEl.innerHTML="";
  history.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+m.role;
    d.innerHTML=m.role==="bot"
      ? `<img src="avatar.png" class="avatar"><div class="bubble">${m.text}</div>`
      : `<div class="bubble">${m.text}</div>`;
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function add(role,text){
  history.push({role,text,state:currentState});
  if(!privateMode) localStorage.setItem("gh_history",JSON.stringify(history));
  render();
}

function showTyping(){
  const d=document.createElement("div");
  d.className="typing";
  d.id="typing";
  d.textContent="…";
  messagesEl.appendChild(d);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}
function hideTyping(){
  const t=document.getElementById("typing");
  if(t)t.remove();
}

/* BOT */
function botSpeak(){
  const s=QA.states[currentState];
  if(!s){
    currentState=QA.start;
    add("bot",QA.states[currentState].text[language]||QA.states[currentState].text.en);
    return;
  }
  add("bot",s.text[language]||s.text.en);
}

/* GLOBAL ROUTES — 30 CATEGORIES */
const GLOBAL_ROUTES=[
{state:"mood_01",keywords:["mood","pakiramdam","feeling","feelings","emotion","emosyon","how are you","kumusta","okay","not okay","hindi okay","mabigat","magaan","empty","parang walang laman","malungkot","good mood","magandang pakiramdam","bad mood","masamang pakiramdam"]},
{state:"food_01",keywords:["food","pagkain","eat","eating","kain","hungry","gutom","dessert","panghimagas","snack","meryenda","lunch","tanghalian","dinner","hapunan","breakfast","almusal","sweets","matamis","salty","maalat","viand","ulam","drinks","inumin"]},
{state:"genz_01",keywords:["genz","gen z","slang","salitang kalye","vibes","vibe","vibe check","check ng vibe","slay","astig","bet","trip","lowkey","patago","highkey","halata","rizz","dating","flex","yabang","cringe","nakakaasiwa","sus","kaduda-duda","iykyk","alam mo na","lit","solid","bussin","panalo"]},
{state:"hobby_01",keywords:["hobby","hobbies","libangan","free time","bakanteng oras","interests","interes","pastime","pinagkakaabalahan","talent","talento","skills","kakayahan","ginagawa mo","trip mo"]},
{state:"crush_01",keywords:["crush","gusto ko","may gusto","mahal","relationship","relasyon","dating","ligawan","ligaw","umamin","heartbreak","wasak ang puso"]},
{state:"cp_overview_01",keywords:["cerebral palsy","cp overview","about cp","ano ang cp","cp basics","cp info","cp condition"]},
{state:"cp_signs_01",keywords:["cp signs","palatandaan ng cp","symptoms","sintomas","delayed movement","hirap gumalaw","stiff muscles","matigas ang kalamnan"]},
{state:"cp_therapy_01",keywords:["therapy","physical therapy","occupational therapy","speech therapy","rehab","rehabilitasyon","exercises","ehersisyo"]},
{state:"care_01",keywords:["care tips","pag-aalaga","daily care","routine care","support care","paano alagaan"]},
{state:"emotional_support_01",keywords:["emotional support","aliw","kailangan kausap","may makikinig","kailangan ng tulong","lonely","nag-iisa"]},
{state:"family_01",keywords:["family","pamilya","parents","magulang","mother","nanay","father","tatay","siblings","kapatid"]},
{state:"daily_life_01",keywords:["daily life","araw-araw na buhay","routine","pang-araw-araw","normal na araw","iskedyul"]},
{state:"medical_01",keywords:["medical","medikal","doctor","doktor","medicine","gamot","hospital","ospital","reseta","gamutan"]},
{state:"anxiety_01",keywords:["anxiety","balisa","stress","panic","panic attack","burnout"]},
{state:"sleep_01",keywords:["sleep","tulog","antok","insomnia","hindi makatulog","puyat"]},
{state:"hotline_01",keywords:["hotline","emergency","crisis","krisis","help line","agarang tulong"]},
{state:"cp_meaning_01",keywords:["meaning of cp","kahulugan ng cp","ano ang cerebral palsy"]},
{state:"cp_specifics_01",keywords:["types of cp","uri ng cp","spastic cp","athetoid","severity","tindi"]},
{state:"parenting_cp_01",keywords:["parenting cp","pagpapalaki ng may cp","magulang ng cp"]},
{state:"social_01",keywords:["social support","friends","kaibigan","community","komunidad","support group"]},
{state:"casual_01",keywords:["casual chat","chat lang","fun","saya","random","kwentuhan","chill"]},
{state:"rant_01",keywords:["rant","reklamo","galit","inis","bwisit","vent"]},
{state:"friendly_01",keywords:["hello","hi","hey","kumusta","good morning","magandang umaga","good evening","magandang gabi"]},
{state:"kids_01",keywords:["kids","bata","child","kid safe","ligtas sa bata","simpleng paliwanag"]},
{state:"bot_intro_01",keywords:["who are you","sino ka","ano ka","bot ka ba","what can you do"]},
{state:"language_01",keywords:["language","wika","tagalog","english","filipino"]},
{state:"settings_01",keywords:["settings","options","privacy","private mode","kids mode","clear history","reset chat"]},
{state:"grounding_01",keywords:["grounding","breathing","paghinga","calm down","kumalma","relax"]},
{state:"encourage_01",keywords:["encouragement","kaya mo yan","stay strong","hope","pag-asa","motivation"]},
{state:"fallback_01",keywords:["di ko gets","not clear","confused","clarify","repeat","ano ibig sabihin"]}
];

function resolveNextState(t){
  t=t.toLowerCase();
  if(currentState===null){
    for(const r of GLOBAL_ROUTES){
      if(r.keywords.some(k=>t.includes(k))) return r.state;
    }
    return QA.start;
  }
  const opts=QA.states[currentState]?.options;
  if(opts){
    for(const o of Object.values(opts)){
      if(o.keywords.some(k=>t.includes(k))) return o.next;
    }
  }
  return currentState;
}

/* EVENTS */
form.onsubmit=e=>{
  e.preventDefault();
  const t=input.value.trim();
  if(!t)return;
  input.value="";
  language=detectLanguage(t);
  add("user",t);
  currentState=resolveNextState(t);
  showTyping();
  setTimeout(()=>{
    hideTyping();
    botSpeak();
  },2000);
};

settingsBtn.onclick=()=>settingsModal.classList.remove("hidden");
closeSettings.onclick=()=>settingsModal.classList.add("hidden");
clearBtn.onclick=()=>{history=[];localStorage.removeItem("gh_history");render();};
privateModeCheckbox.onchange=e=>privateMode=e.target.checked;

avatarInput.onchange=()=>{
  const f=avatarInput.files[0];
  const r=new FileReader();
  r.onload=()=>{
    userAvatar.src=r.result;
    localStorage.setItem("gh_avatar",r.result);
  };
  r.readAsDataURL(f);
};
const savedAvatar=localStorage.getItem("gh_avatar");
if(savedAvatar) userAvatar.src=savedAvatar;

/* LOAD QA */
fetch("./qa.json",{cache:"no-store"}).then(r=>r.json()).then(d=>{QA=d;});
</script>
</body>
</html>
