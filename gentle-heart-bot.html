<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Gentle Heart</title>

<style>
:root{
  --emerald:#04331f;
  --emerald-dark:#032718;
  --emerald-soft:#0e6e47;
  --bot:#1a8f63;
  --user:#0b3d28;
}
html,body{margin:0;height:100%}
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--emerald);
  display:flex;
  flex-direction:column;
}
header{
  background:var(--emerald-dark);
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
header img{width:36px;height:36px;border-radius:50%;background:#fff}
.header-title{text-align:center;flex:1}
#chat{flex:1;padding:12px;overflow-y:auto}
.msg{
  max-width:80%;
  padding:12px 14px;
  margin:10px 0;
  border-radius:16px;
  line-height:1.4;
  color:#fff;
}
.bot{background:var(--bot)}
.user{background:var(--user);margin-left:auto}
#inputWrap{
  position:sticky;bottom:0;
  background:var(--emerald);
  padding:10px env(safe-area-inset-right)
          calc(10px + env(safe-area-inset-bottom))
          env(safe-area-inset-left);
  display:flex;gap:8px;
}
input{flex:1;padding:12px;border-radius:12px;border:none}
button{
  padding:12px 18px;border-radius:12px;border:none;
  background:var(--emerald-soft);color:#fff;
}
</style>
</head>

<body>

<header>
  <img src="avatar.png">
  <div class="header-title">
    <strong>Gentle Heart</strong><br>
    <small>Your gentle companion</small>
  </div>
  <div>⚙️</div>
</header>

<div id="chat"></div>

<div id="inputWrap">
  <input id="userInput" placeholder="Type here…">
  <button id="sendBtn">Send</button>
</div>

<script>
/* ================= CORE ================= */
let QA = null;
let currentStateId = null;
let lang = 'en';

const chat = document.getElementById('chat');
const input = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

/* ================= LOAD QA ================= */
(async()=>{
  const res = await fetch('./qa.json');
  QA = await res.json();
  currentStateId = QA.start;
})();

/* ================= UTIL ================= */
const norm = t => t.toLowerCase().trim();
const isTL = t => /(kumusta|hindi|mabigat|pagod|gutom|salamat|ako|ka)/i.test(t);

function say(text, who){
  const d=document.createElement('div');
  d.className='msg '+who;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ================= GLOBAL ROUTER INDEX ================= */
/* BUILT ONCE, USED EVERYWHERE */
let GLOBAL_KEYWORD_INDEX = {};

function buildGlobalRouter(){
  for(const [stateId, state] of Object.entries(QA.states)){
    if(!state.keywords) continue;
    state.keywords.forEach(k=>{
      const key = norm(k);
      GLOBAL_KEYWORD_INDEX[key] = stateId;
    });
  }
}

/* ================= LOCAL ROUTER ================= */
function routeByOptions(text){
  const t = norm(text);
  const state = QA.states[currentStateId];
  if(!state || !state.options) return null;

  for(const opt of state.options){
    const en = norm(opt.label_en);
    const tl = norm(opt.label_tl);
    if(t === en || t === tl || t.includes(en) || t.includes(tl)){
      return opt.next;
    }
  }
  return null;
}

/* ================= GLOBAL ROUTER ================= */
function routeByGlobalKeywords(text){
  const t = norm(text);
  for(const key in GLOBAL_KEYWORD_INDEX){
    if(t.includes(key)){
      return GLOBAL_KEYWORD_INDEX[key];
    }
  }
  return null;
}

/* ================= MASTER ROUTER ================= */
function resolveNextState(text){
  // 1. CURRENT STATE OPTIONS (STRICT)
  const byOption = routeByOptions(text);
  if(byOption) return byOption;

  // 2. GLOBAL ROUTER (ANY STATE)
  const byGlobal = routeByGlobalKeywords(text);
  if(byGlobal) return byGlobal;

  // 3. NO MATCH
  return null;
}

/* ================= SEND ================= */
sendBtn.onclick = () => {
  const text = input.value.trim();
  if(!text || !QA) return;

  lang = isTL(text) ? 'tl' : 'en';
  say(text,'user');
  input.value='';

  // build router once
  if(Object.keys(GLOBAL_KEYWORD_INDEX).length === 0){
    buildGlobalRouter();
  }

  const next = resolveNextState(text);
  if(next){
    currentStateId = next;
    say(QA.states[currentStateId].text[lang],'bot');
  }else{
    say(
      lang==='tl'
        ? 'Okay lang. Alin ang mas malapit sa pakiramdam mo?'
        : 'That’s okay. Which feels closer?',
      'bot'
    );
  }
};
</script>

</body>
</html>
