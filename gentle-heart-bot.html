<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gentle Heart</title>

<style>
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:#f6fbf8;
    display:flex;
    flex-direction:column;
    height:100vh;
  }

  header{
    background:#06442a;
    color:#fff;
    padding:14px;
    text-align:center;
  }

  #chat{
    flex:1;
    padding:12px;
    overflow-y:auto;
  }

  .bot, .user{
    max-width:80%;
    padding:10px 12px;
    margin:8px 0;
    border-radius:12px;
    line-height:1.4;
    font-size:15px;
  }

  .bot{
    background:#e3f2eb;
    align-self:flex-start;
  }

  .user{
    background:#06442a;
    color:#fff;
    align-self:flex-end;
  }

  #options{
    padding:10px;
    display:flex;
    gap:8px;
  }

  button{
    flex:1;
    padding:10px;
    border-radius:10px;
    border:none;
    background:#0e6e47;
    color:#fff;
    font-size:14px;
  }

  button:active{
    opacity:.85;
  }

  #inputWrap{
    display:flex;
    padding:10px;
    gap:8px;
    border-top:1px solid #ddd;
  }

  input{
    flex:1;
    padding:10px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:14px;
  }
</style>
</head>

<body>

<header>
  <strong>Gentle Heart</strong><br/>
  <small>Your gentle companion</small>
</header>

<div id="chat"></div>
<div id="options"></div>

<div id="inputWrap">
  <input id="userInput" placeholder="Type hereâ€¦" />
  <button onclick="sendUser()">Send</button>
</div>

<script>
/* =========================
   CORE STATE
========================= */
let QA = null;
let currentStateId = null;
const chat = document.getElementById('chat');
const optionsWrap = document.getElementById('options');
const input = document.getElementById('userInput');

/* =========================
   LOAD QA.JSON
========================= */
async function loadQA(){
  const res = await fetch('./qa.json');
  QA = await res.json();
  currentStateId = QA.start;
  renderState(QA.states[currentStateId]);
}

/* =========================
   UTIL
========================= */
function normalize(text){
  return text.toLowerCase().trim();
}

function addMessage(text, cls){
  const div = document.createElement('div');
  div.className = cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* =========================
   ROUTER
========================= */
function findStateByKeyword(inputText){
  const t = normalize(inputText);

  for(const [id, state] of Object.entries(QA.states)){
    if(!state.keywords) continue;
    for(const kw of state.keywords){
      if(t.includes(kw)) return id;
    }
  }
  return null;
}

function resolveNextState(userText){
  const matched = findStateByKeyword(userText);
  if(matched){
    currentStateId = matched;
    return QA.states[currentStateId];
  }
  return QA.states[currentStateId];
}

/* =========================
   RENDER
========================= */
function renderState(state){
  addMessage(state.text.en, 'bot');
  renderOptions(state.options);
}

function renderOptions(opts){
  optionsWrap.innerHTML = '';
  opts.forEach((o, i) => {
    const btn = document.createElement('button');
    btn.textContent = o.label_en;
    btn.onclick = () => selectOption(i);
    optionsWrap.appendChild(btn);
  });
}

/* =========================
   EVENTS
========================= */
function sendUser(){
  const text = input.value.trim();
  if(!text) return;
  addMessage(text, 'user');
  input.value = '';
  const state = resolveNextState(text);
  renderState(state);
}

function selectOption(index){
  const nextId = QA.states[currentStateId].options[index].next;
  currentStateId = nextId;
  renderState(QA.states[currentStateId]);
}

/* =========================
   START
========================= */
loadQA();
</script>

</body>
</html>
