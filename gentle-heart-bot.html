<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gentle Heart</title>

<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#06442a">

<style>
:root{
  --emerald-900:#04331f;
  --emerald-800:#06442a;
  --emerald-700:#0b5b39;
  --emerald-600:#0e6e47;
  --emerald-500:#1aa667;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--emerald-900);}
.app{min-height:100vh;display:flex;justify-content:center;}
.chat-shell{width:100%;max-width:560px;display:flex;flex-direction:column;color:#fff}

.header{
  position:fixed;top:0;left:0;right:0;
  max-width:560px;margin:auto;
  padding:14px 16px;
  display:flex;align-items:center;gap:12px;
  background:linear-gradient(180deg,var(--emerald-800),var(--emerald-700));
  z-index:1000;
}
.header img{width:40px;height:40px;border-radius:10px}
.title{font-weight:700}
.subtitle{font-size:12px;opacity:.8}
.user-area{margin-left:auto;display:flex;align-items:center;gap:10px}
.user-avatar{width:34px;height:34px;border-radius:50%;border:2px solid rgba(255,255,255,.6)}
.settings-btn{background:none;border:none;color:#fff;font-size:20px}

.messages{
  flex:1;
  padding:84px 16px 16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:auto;
}

.msg{display:flex;gap:8px}
.msg.bot{justify-content:flex-start}
.msg.user{justify-content:flex-end}
.avatar{width:26px;height:26px;border-radius:50%}
.bubble{padding:8px 12px;border-radius:14px;max-width:75%;white-space:pre-wrap}
.msg.bot .bubble{background:linear-gradient(180deg,var(--emerald-700),var(--emerald-600))}
.msg.user .bubble{background:#fff;color:#04331f}

.input-bar{
  display:flex;gap:8px;padding:12px;
  position:sticky;bottom:0;background:#04331f
}
.input-bar input{flex:1;padding:12px;border-radius:999px;border:0}
.input-bar button{padding:12px 16px;border-radius:999px;border:0;background:#1aa667}

.settings-modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:flex;align-items:center;justify-content:center
}
.hidden{display:none}
.settings-panel{
  background:#04331f;padding:18px;border-radius:14px;
  width:90%;max-width:320px
}
.settings-actions{display:flex;gap:10px;margin-top:12px}
.settings-actions button{flex:1;padding:10px;border-radius:10px;border:0;background:#1aa667}
</style>
</head>

<body>
<div class="app">
<div class="chat-shell">

<div class="header">
  <img src="avatar.png">
  <div>
    <div class="title">Gentle Heart</div>
    <div class="subtitle">Your gentle companion</div>
  </div>
  <div class="user-area">
    <img id="userAvatarPreview" class="user-avatar" src="user-default.png">
    <button id="settingsBtn" class="settings-btn">⚙️</button>
  </div>
</div>

<div id="messages" class="messages"></div>

<form id="chatForm" class="input-bar">
  <input id="userInput" placeholder="Say something…">
  <button>Send</button>
</form>

</div>
</div>

<div id="settingsModal" class="settings-modal hidden">
  <div class="settings-panel">
    <h3>Settings</h3>

    <label><input type="checkbox" id="kidsMode"> Kids mode</label><br><br>

    <label>Country</label>
    <select id="countrySelect">
      <option value="PH">Philippines</option>
      <option value="INT">International</option>
    </select><br><br>

    <label><input type="checkbox" id="privateMode"> Private mode</label>

    <div class="settings-actions">
      <button type="button" id="clearHistoryBtn">Clear chat</button>
      <button type="button" id="closeSettingsBtn">Close</button>
    </div>
  </div>
</div>

<script>
const messagesEl = document.getElementById("messages");
const form = document.getElementById("chatForm");
const input = document.getElementById("userInput");

const settingsModal = document.getElementById("settingsModal");
const settingsBtn = document.getElementById("settingsBtn");
const closeSettingsBtn = document.getElementById("closeSettingsBtn");
const clearHistoryBtn = document.getElementById("clearHistoryBtn");
const privateModeCheckbox = document.getElementById("privateMode");

let history = JSON.parse(localStorage.getItem("gh_history")||"[]");
let QA = null;
let currentState = null;
let language = "en";
let privateMode = false;

function detectLanguage(t){
  return /(kumusta|pakiramdam|nararamdaman|emosyon|gutom|matamis|mabigat|magaan|antok|pahinga)/i.test(t)
    ? "tl" : "en";
}

fetch("./qa.json",{cache:"no-store"}).then(r=>r.json()).then(d=>{
  QA = d;
  if(history.length){
    currentState = history[history.length-1].state || null;
    render();
  }
});

function render(){
  messagesEl.innerHTML="";
  history.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+m.role;
    d.innerHTML = m.role==="bot"
      ? `<img src="avatar.png" class="avatar"><div class="bubble">${m.text}</div>`
      : `<div class="bubble">${m.text}</div>`;
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function add(role,text){
  history.push({role,text,state:currentState});
  if(!privateMode) localStorage.setItem("gh_history",JSON.stringify(history));
  render();
}

function botSpeak(){
  const s = QA.states[currentState];
  if(!s){
    add("bot", language==="tl"
      ? "Hindi ko masundan. Pwede mo bang piliin ang isa sa dalawang options?"
      : "I couldn’t follow that. Can you choose one of the two options?"
    );
    return;
  }
  add("bot", s.text[language] || s.text.en);
}

/* ===============================
   GLOBAL ENTRY ROUTES — 30 CATEGORIES
   =============================== */
const GLOBAL_ROUTES = [
  {state:"mood_01",keywords:["mood","pakiramdam","feeling","feelings","nararamdaman","emotion","emotions","emosyon","how are you","kumusta","okay","okay ba","okay lang","not okay","hindi okay","heavy","mabigat","light","magaan","empty","parang walang laman","down","low","malungkot","good mood","magandang pakiramdam","bad mood","masamang pakiramdam"]},
  {state:"food_01",keywords:["food","pagkain","eat","eating","kain","hungry","gutom","dessert","panghimagas","snack","meryenda","lunch","tanghalian","dinner","hapunan","breakfast","almusal","sweets","matamis","salty","maalat","viand","ulam","drinks","inumin"]},
  {state:"genz_01",keywords:["genz","gen z","slang","salitang kalye","vibes","vibe","vibe check","check ng vibe","slay","astig","bet","trip","lowkey","patago","highkey","halata","rizz","dating","flex","yabang","cringe","nakakaasiwa","sus","kaduda-duda","iykyk","alam mo na","lit","solid","bussin","masarap","panalo"]},
  {state:"hobby_01",keywords:["hobby","hobbies","libangan","free time","bakanteng oras","interests","interes","pastime","pinagkakaabalahan","talent","talento","skills","kakayahan","what you do","ginagawa mo","things you enjoy","trip mo"]},
  {state:"crush_01",keywords:["crush","like someone","gusto ko","have feelings","may gusto","love","mahal","relationship","relasyon","dating","ligawan","courtship","ligaw","confess","umamin","heartbreak","wasak ang puso","feelings for someone","feelings sa tao"]},
  {state:"cp_overview_01",keywords:["cerebral palsy","cp overview","about cp","what is cp","ano ang cp","cp basics","cp info","cp condition"]},
  {state:"cp_signs_01",keywords:["cp signs","palatandaan ng cp","symptoms","sintomas","delayed movement","delayed na galaw","difficulty moving","hirap gumalaw","stiff muscles","matigas ang kalamnan","spastic"]},
  {state:"cp_therapy_01",keywords:["therapy","physical therapy","occupational therapy","speech therapy","rehab","rehabilitasyon","exercises","ehersisyo","therapy session"]},
  {state:"care_01",keywords:["care tips","tips sa pag-aalaga","caregiving","pag-aalaga","daily care","araw-araw na alaga","routine care","support care","how to care","paano alagaan"]},
  {state:"emotional_support_01",keywords:["emotional support","emosyonal na suporta","comfort","aliw","need someone to talk to","kailangan kausap","someone listening","may makikinig ba","need help","kailangan ng tulong","lonely","nag-iisa"]},
  {state:"family_01",keywords:["family","pamilya","parents","magulang","mother","nanay","father","tatay","siblings","kapatid","relatives","kamag-anak","family help","tulong ng pamilya"]},
  {state:"daily_life_01",keywords:["daily life","araw-araw na buhay","routine","everyday life","pang-araw-araw","normal day","normal na araw","schedule","iskedyul"]},
  {state:"medical_01",keywords:["medical","medikal","doctor","doktor","medicine","gamot","diagnosis","checkup","hospital","ospital","prescription","reseta","treatment","gamutan"]},
  {state:"anxiety_01",keywords:["anxiety","anxious","balisa","stress","panic","panic attack","nervous","nerbyos","overwhelmed","napupuno","burnout"]},
  {state:"sleep_01",keywords:["sleep","tulog","sleepy","antok","insomnia","can’t sleep","hindi makatulog","trouble sleeping","hirap matulog","rest","pahinga","puyat"]},
  {state:"hotline_01",keywords:["hotline","emergency","crisis","krisis","help line","linya ng tulong","suicide hotline","urgent help","agarang tulong"]},
  {state:"cp_meaning_01",keywords:["meaning of cp","ibig sabihin ng cp","cp definition","what is cerebral palsy","ano ang cerebral palsy"]},
  {state:"cp_specifics_01",keywords:["types of cp","uri ng cp","spastic cp","athetoid cp","severity","tindi","mild cp","severe cp","classification","klasipikasyon"]},
  {state:"parenting_cp_01",keywords:["parenting cp","raising a child with cp","cp parent","how to care for child","paano mag-alaga ng anak"]},
  {state:"social_01",keywords:["social support","friends","kaibigan","community","komunidad","support group","social life","buhay panlipunan","someone to talk to","may kausap"]},
  {state:"casual_01",keywords:["casual chat","chat lang","fun","saya","random chat","random na usap","small talk","kwentuhan","chill"]},
  {state:"rant_01",keywords:["rant","complain","reklamo","angry","galit","annoyed","inis","frustrated","bwisit","vent","maglabas ng sama ng loob"]},
  {state:"friendly_01",keywords:["hello","hi","hey","kumusta","friendly","palakaibigan","greetings","bati","good morning","magandang umaga","good evening","magandang gabi"]},
  {state:"kids_01",keywords:["kids","bata","child","kid safe","ligtas sa bata","simple explanation","simpleng paliwanag","easy to understand","madaling intindihin"]},
  {state:"bot_intro_01",keywords:["who are you","sino ka","what are you","ano ka","are you a bot","bot ka ba","what can you do","anong kaya mo","limits","limitasyon","rules","patakaran"]},
  {state:"language_01",keywords:["language","wika","tagalog","english","filipino","change language","palitan ang wika"]},
  {state:"settings_01",keywords:["settings","options","privacy","private mode","kids mode","clear history","burahin ang chat","reset chat","i-reset ang chat"]},
  {state:"grounding_01",keywords:["grounding","breathing","paghinga","inhale","hinga papasok","exhale","hinga palabas","calm down","kumalma","relax","mag-relax","focus","mag-focus"]},
  {state:"encourage_01",keywords:["encouragement","pampalakas-loob","affirmations","you got this","kaya mo yan","stay strong","magpakatatag","hope","pag-asa","motivation","motibasyon"]},
  {state:"fallback_01",keywords:["i don’t understand","di ko gets","not clear","di malinaw","confused","nalilito","clarify","linawin","repeat","ulit","what do you mean","ano ibig sabihin"]}
];

function resolveNextState(t){
  t = t.toLowerCase();

  if(!currentState){
    for(const r of GLOBAL_ROUTES){
      if(r.keywords.some(k=>t.includes(k))) return r.state;
    }
    return "mood_01";
  }

  const opts = QA.states[currentState]?.options;
  if(opts){
    for(const o of Object.values(opts)){
      if(o.keywords.some(k=>t.includes(k.toLowerCase()))) return o.next;
    }
  }

  return currentState;
}

form.onsubmit=e=>{
  e.preventDefault();
  const t=input.value.trim();
  if(!t)return;
  input.value="";
  language = detectLanguage(t);
  add("user",t);
  currentState = resolveNextState(t);
  setTimeout(botSpeak,400);
};

settingsBtn.onclick=()=>settingsModal.classList.remove("hidden");
closeSettingsBtn.onclick=()=>settingsModal.classList.add("hidden");
clearHistoryBtn.onclick=()=>{history=[];localStorage.removeItem("gh_history");render();}
privateModeCheckbox.onchange=e=>privateMode=e.target.checked;
</script>
</body>
</html>
