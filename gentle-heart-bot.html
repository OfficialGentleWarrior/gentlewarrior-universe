<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gentle Heart</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#06442a">

<style>
:root{
  --emerald-900:#04331f;
  --emerald-800:#06442a;
  --emerald-700:#0b5b39;
  --emerald-600:#0e6e47;
  --emerald-500:#1aa667;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--emerald-900);}

.app{min-height:100vh;display:flex;justify-content:center;}
.chat-shell{width:100%;max-width:560px;display:flex;flex-direction:column;color:#fff}

/* HEADER */
.header{
  position:fixed;top:0;left:0;right:0;
  max-width:560px;margin:auto;
  padding:14px 16px;
  display:flex;align-items:center;gap:12px;
  background:linear-gradient(180deg,var(--emerald-800),var(--emerald-700));
  z-index:1000;
}
.header img{width:40px;height:40px;border-radius:10px}
.title{font-weight:700}
.subtitle{font-size:12px;opacity:.8}

.user-area{margin-left:auto;display:flex;align-items:center;gap:10px}
.user-avatar{width:34px;height:34px;border-radius:50%;border:2px solid rgba(255,255,255,.6);object-fit:cover}
.settings-btn{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}

/* CHAT */
.messages{
  flex:1;padding:84px 16px 16px;
  display:flex;flex-direction:column;gap:12px;overflow:auto
}
.msg{display:flex;gap:8px}
.msg.bot{justify-content:flex-start}
.msg.user{justify-content:flex-end}

.avatar{width:26px;height:26px;border-radius:50%}
.bubble{padding:8px 12px;border-radius:14px;max-width:75%;white-space:pre-wrap}
.msg.bot .bubble{background:linear-gradient(180deg,var(--emerald-700),var(--emerald-600))}
.msg.user .bubble{background:#fff;color:#04331f}

.input-bar{display:flex;gap:8px;padding:12px;position:sticky;bottom:0;background:#04331f}
.input-bar input{flex:1;padding:12px;border-radius:999px;border:0}
.input-bar button{padding:12px 16px;border-radius:999px;border:0;background:#1aa667;font-weight:600}

/* SETTINGS */
.settings-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
.hidden{display:none}
.settings-panel{background:#04331f;padding:18px;border-radius:14px;width:90%;max-width:320px}
</style>
</head>

<body>
<div class="app">
<div class="chat-shell">

<div class="header">
  <img src="avatar.png">
  <div>
    <div class="title">Gentle Heart</div>
    <div class="subtitle">Your gentle companion</div>
  </div>
  <div class="user-area">
    <label>
      <input type="file" id="userAvatarInput" hidden>
      <img id="userAvatarPreview" class="user-avatar" src="user-default.png">
    </label>
    <button id="settingsBtn" class="settings-btn">⚙️</button>
  </div>
</div>

<div id="messages" class="messages"></div>

<form id="chatForm" class="input-bar">
  <input id="userInput" placeholder="Say something…">
  <button>Send</button>
</form>

</div>
</div>

<div id="settingsModal" class="settings-modal hidden">
  <div class="settings-panel">
    <h3>Settings</h3>
    <label><input type="checkbox" id="privateMode"> Private mode</label><br><br>
    <button id="clearHistoryBtn">Clear chat</button><br><br>
    <button id="closeSettingsBtn">Close</button>
  </div>
</div>

<script>
const messagesEl=document.getElementById("messages");
const form=document.getElementById("chatForm");
const input=document.getElementById("userInput");

let history=JSON.parse(localStorage.getItem("gh_history")||"[]");
let QA=null;
let currentState=null;
let language="en";
let privateMode=false;

/* LANGUAGE */
function detectLanguage(t){
  return /(ako|mo|ka|pakiramdam|nararamdaman|emosyon|kumusta|gutom|pagod|mabigat|magaan|tulog|hinga)/i.test(t)
    ? "tl" : "en";
}

/* LOAD QA */
fetch("./qa.json",{cache:"no-store"}).then(r=>r.json()).then(d=>{
  QA=d;
  currentState=QA.start;
  if(history.length) render();
  else botSpeak();
});

/* RENDER */
function render(){
  messagesEl.innerHTML="";
  history.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+m.role;
    d.innerHTML=m.role==="bot"
      ? `<img src="avatar.png" class="avatar"><div class="bubble">${m.text}</div>`
      : `<div class="bubble">${m.text}</div>`;
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function add(role,text){
  history.push({role,text});
  if(!privateMode) localStorage.setItem("gh_history",JSON.stringify(history));
  render();
}

/* BOT */
function botSpeak(){
  if(!QA || !QA.states || !QA.states[currentState]) {
    add("bot", language==="tl" ? "Narito lang ako." : "I’m here with you.");
    return;
  }
  const s=QA.states[currentState];
  add("bot",s.text[language]||s.text.en);
}

/* ===============================
   GLOBAL ROUTER — 30 CATEGORIES
   =============================== */
const GLOBAL_ROUTES = [
  {state:"mood_01",keywords:["mood","feeling","feelings","pakiramdam","nararamdaman","emosyon","emotion","kumusta","how are you","okay lang","okay ba","hindi okay","mabigat","magaan","empty","down","low","good mood","bad mood"]},
  {state:"food_01",keywords:["food","eat","eating","kain","gutom","hungry","dessert","snack","meryenda","pagkain","lunch","dinner","breakfast","sweets","matamis","salty","ulam","inumin"]},
  {state:"genz_01",keywords:["genz","slang","vibes","vibe check","slay","bet","lowkey","highkey","rizz","flex","cringe","sus","iykyk","sheesh","lit","bussin"]},
  {state:"hobby_01",keywords:["hobby","hobbies","libangan","ginagawa","ginagawa mo","free time","interests","trip mo","pastime","pinagkakaabalahan","talent","skills"]},
  {state:"crush_01",keywords:["crush","gusto ko","like ko","may gusto","love","mahal","relasyon","relationship","dating","ligaw","feelings sa tao","umamin","heartbreak"]},
  {state:"cp_overview_01",keywords:["cerebral palsy","cp overview","about cp","ano ang cp","cp basics","cp info","tungkol sa cp","condition cp"]},
  {state:"cp_signs_01",keywords:["cp signs","signs of cp","sintomas","palatandaan","delayed movement","delayed development","hirap gumalaw","stiff muscles","spastic"]},
  {state:"cp_therapy_01",keywords:["therapy","therapy for cp","pt","physical therapy","ot","occupational therapy","speech therapy","rehab","exercises","therapy session"]},
  {state:"care_01",keywords:["care tips","caregiving","pag-aalaga","alaga","daily care","tips","paano alagaan","routine care","support care"]},
  {state:"emotional_support_01",keywords:["emotional support","comfort","kailangan kausap","may makikinig ba","support","hindi okay","need help","need comfort","lonely"]},
  {state:"family_01",keywords:["family","pamilya","magulang","parents","nanay","tatay","kapatid","relatives","support ng pamilya","family help"]},
  {state:"daily_life_01",keywords:["daily life","araw-araw","routine","everyday life","normal day","daily routine","buhay araw-araw","schedule"]},
  {state:"medical_01",keywords:["medical","doctor","doktor","gamot","medicine","diagnosis","checkup","ospital","hospital","reseta","treatment"]},
  {state:"anxiety_01",keywords:["anxiety","anxious","stress","stressed","panic","panic attack","kaba","nerbyos","overwhelmed","pressure","burnout"]},
  {state:"sleep_01",keywords:["sleep","tulog","antok","insomnia","hindi makatulog","hirap matulog","rest","pahinga","puyat"]},
  {state:"hotline_01",keywords:["hotline","emergency","crisis","help line","suicide hotline","tawagan","urgent help","emergency number","kailangan ng tulong"]},
  {state:"cp_meaning_01",keywords:["meaning of cp","ano ibig sabihin ng cp","definition cp","cp meaning","ano ang cerebral palsy"]},
  {state:"cp_specifics_01",keywords:["types of cp","spastic cp","athetoid cp","severity","mild cp","severe cp","cp details","classification"]},
  {state:"parenting_cp_01",keywords:["parenting cp","pagpapalaki","pagpapalaki ng may cp","parent ng cp child","paano mag-alaga","pagpapalaki ng anak"]},
  {state:"social_01",keywords:["social support","kaibigan","friends","community","support group","pakikisalamuha","social life","may kausap"]},
  {state:"casual_01",keywords:["casual chat","chat lang","kwentuhan","fun","random","usap lang","chill","light talk","small talk"]},
  {state:"rant_01",keywords:["rant","reklamo","galit","inis","bwisit","bad trip","gusto maglabas","vent","rant lang"]},
  {state:"friendly_01",keywords:["hello","hi","hey","kumusta","kausap","friendly","bati","good morning","good evening","musta"]},
  {state:"kids_01",keywords:["kids","bata","child","pang bata","kid safe","kids safe","simple explain","madaling paliwanag"]},
  {state:"bot_intro_01",keywords:["sino ka","what are you","bot ka ba","anong kaya mo","what can you do","limits","rules","ano ka"]},
  {state:"language_01",keywords:["language","tagalog","english","filipino","salita","magsalita","palitan ng wika","language setting"]},
  {state:"settings_01",keywords:["settings","option","options","privacy","private mode","kids mode","clear history","reset chat","preferences"]},
  {state:"grounding_01",keywords:["grounding","breathing","breathe","hinga","inhale","exhale","calm down","relax","slow down","focus"]},
  {state:"encourage_01",keywords:["encouragement","affirmations","kaya mo yan","you got this","lakas ng loob","hope","motivation","inspiring"]},
  {state:"fallback_01",keywords:["di ko gets","hindi ko maintindihan","di malinaw","ulit","clarify","misunderstanding","confused","ano ibig sabihin","fallback"]}
];

/* NEXT STATE */
function resolveNextState(t){
  t=t.toLowerCase();

  for(const r of GLOBAL_ROUTES){
    for(const k of r.keywords){
      if(t.includes(k.toLowerCase())) return r.state;
    }
  }

  const s=QA.states[currentState];
  if(!s || !s.options) return currentState;

  for(const o of Object.values(s.options)){
    for(const k of o.keywords||[]){
      if(t.includes(k)) return o.next;
    }
  }
  return currentState;
}

/* INPUT */
form.onsubmit=e=>{
  e.preventDefault();
  const t=input.value.trim();
  if(!t)return;
  input.value="";
  add("user",t);

  language=detectLanguage(t);
  currentState=resolveNextState(t);
  setTimeout(botSpeak,400);
};

/* SETTINGS */
settingsBtn.onclick=()=>settingsModal.classList.remove("hidden");
closeSettingsBtn.onclick=()=>settingsModal.classList.add("hidden");
clearHistoryBtn.onclick=()=>{history=[];localStorage.removeItem("gh_history");render();}
privateMode.onchange=e=>privateMode=e.target.checked;

/* AVATAR */
userAvatarInput.onchange=()=>{
  const f=userAvatarInput.files[0];
  const r=new FileReader();
  r.onload=()=>{userAvatarPreview.src=r.result;localStorage.setItem("userAvatar",r.result);}
  r.readAsDataURL(f);
}
const saved=localStorage.getItem("userAvatar");
if(saved) userAvatarPreview.src=saved;
</script>
</body>
</html>
