<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Gentle Heart</title>

<style>
:root{
  --emerald:#04331f;
  --emerald2:#06442a;
  --light:#f6fbf8;
}

/* full height */
html,body{
  margin:0;
  height:100%;
}

body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--emerald);
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:var(--emerald2);
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.header-left,.header-right{
  display:flex;
  align-items:center;
  gap:10px;
}

header img{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#fff;
}

.header-title{
  text-align:center;
  flex:1;
}

/* CHAT AREA */
#chat{
  flex:1;
  background:var(--light);
  padding:12px;
  overflow-y:auto;
  border-radius:16px 16px 0 0;
}

.msg{
  max-width:80%;
  padding:10px 12px;
  margin:8px 0;
  border-radius:14px;
  line-height:1.4;
}

.bot{ background:#e3f2eb; }
.user{
  background:var(--emerald2);
  color:#fff;
  margin-left:auto;
}

/* INPUT */
#inputWrap{
  position:sticky;
  bottom:0;
  background:var(--light);
  padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
  display:flex;
  gap:8px;
  border-top:1px solid #ddd;
}

input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}

button{
  padding:10px 16px;
  border-radius:10px;
  border:none;
  background:var(--emerald2);
  color:#fff;
}

button:disabled{opacity:.5}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-box{
  background:#fff;
  padding:20px;
  border-radius:14px;
  width:85%;
}

.modal-box h3{margin-top:0}

.modal-box label{
  display:flex;
  justify-content:space-between;
  margin:10px 0;
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="avatar.png" alt="bot avatar">
  </div>

  <div class="header-title">
    <strong>Gentle Heart</strong><br>
    <small>Your gentle companion</small>
  </div>

  <div class="header-right">
    <!-- user avatar -->
    <input type="file" id="userAvatarInput" hidden accept="image/*">
    <img id="userAvatar" style="cursor:pointer;" alt="user avatar">
    <!-- settings gear -->
    <span style="cursor:pointer;font-size:20px;" id="gearBtn">⚙️</span>
  </div>
</header>

<div id="chat"></div>

<div id="inputWrap">
  <input id="userInput" placeholder="Type here…">
  <button id="sendBtn" disabled>Send</button>
</div>

<!-- SETTINGS -->
<div class="modal" id="settings">
  <div class="modal-box">
    <h3>Settings</h3>

    <label>Kids Mode <input type="checkbox" id="kidsMode"></label>
    <label>Private Mode <input type="checkbox" id="privateMode"></label>

    <label>
      Country
      <select id="countrySelect">
        <option>Philippines</option>
        <option>International</option>
      </select>
    </label>

    <button onclick="clearHistory()">Clear History</button>
    <br><br>
    <button onclick="closeSettings()">Close</button>
  </div>
</div>

<script>
/* STATE */
let QA=null,currentStateId=null,currentLang='en';
const chat=document.getElementById('chat');
const input=document.getElementById('userInput');
const sendBtn=document.getElementById('sendBtn');
const userAvatar=document.getElementById('userAvatar');
const userAvatarInput=document.getElementById('userAvatarInput');
const gearBtn=document.getElementById('gearBtn');
const settingsModal=document.getElementById('settings');

/* LOAD QA */
(async()=>{
  try{
    const res=await fetch('./qa.json');
    QA=await res.json();
    currentStateId=QA.start;
    sendBtn.disabled=false;
    // show initial prompt on load
    addMsg(QA.states[currentStateId].text.en,'bot');
  }catch(e){
    console.error('QA load failed',e);
  }
})();

/* UTIL */
const normalize=t=>t.toLowerCase().trim();
function isTagalog(t){
  return /(kumusta|hindi|mabigat|gutom|ok|okay|pakiramdam|salamat|magaan|nakakatulong)/i.test(t);
}
function addMsg(text,cls){
  const d=document.createElement('div');
  d.className='msg '+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ROUTER: find matching state by keyword */
function resolve(text){
  const t=normalize(text);
  // try keyword match
  for(const [id,s] of Object.entries(QA.states)){
    if(!s.keywords) continue;
    if(s.keywords.some(k=>t.includes(k))){
      currentStateId=id;
      return QA.states[id];
    }
  }
  // no change if no match
  return null;
}

/* SEND */
sendBtn.onclick=()=>{
  if(!QA)return;
  const t=input.value.trim();
  if(!t)return;

  // detect language
  currentLang=isTagalog(t)?'tl':'en';

  // user message
  addMsg(t,'user');
  input.value='';

  // resolve next state
  const next=resolve(t);
  if(next){
    const txt=next.text[currentLang] || next.text.en;
    addMsg(txt,'bot');
  }
};

/* SETTINGS */
gearBtn.onclick=()=>openSettings();
function openSettings(){settingsModal.style.display='flex'}
function closeSettings(){settingsModal.style.display='none'}
function clearHistory(){chat.innerHTML=''; closeSettings()}

/* USER AVATAR UPLOAD */
userAvatarInput.onchange=e=>{
  const f=e.target.files[0];
  if(f) userAvatar.src=URL.createObjectURL(f);
};
userAvatar.onclick=()=>userAvatarInput.click();

/* simple click outside modal to close */
settingsModal.onclick=e=>{
  if(e.target===settingsModal) closeSettings();
};
</script>

</body>
</html>
