<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Gentle Heart</title>

<style>
:root{
  --emerald:#04331f;
  --emerald-dark:#032718;
  --emerald-soft:#0e6e47;
  --bot:#1a8f63;
  --user:#0b3d28;
}

html,body{margin:0;height:100%}

body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--emerald);
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:var(--emerald-dark);
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.header-left,.header-right{
  display:flex;
  align-items:center;
  gap:10px;
}
header img{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#fff;
}
.header-title{text-align:center;flex:1}

/* CHAT */
#chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
}
.msg{
  max-width:80%;
  padding:12px 14px;
  margin:10px 0;
  border-radius:16px;
  line-height:1.4;
  color:#fff;
}
.bot{background:var(--bot)}
.user{background:var(--user);margin-left:auto}

/* INPUT */
#inputWrap{
  position:sticky;
  bottom:0;
  background:var(--emerald);
  padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
  display:flex;
  gap:8px;
}
input{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:none;
}
button{
  padding:12px 18px;
  border-radius:12px;
  border:none;
  background:var(--emerald-soft);
  color:#fff;
}

/* SETTINGS MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-box{
  background:#fff;
  padding:20px;
  border-radius:14px;
  width:85%;
}
.modal-box h3{margin-top:0}
.modal-box label{
  display:flex;
  justify-content:space-between;
  margin:10px 0;
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="avatar.png">
  </div>

  <div class="header-title">
    <strong>Gentle Heart</strong><br>
    <small>Your gentle companion</small>
  </div>

  <div class="header-right">
    <input type="file" id="userAvatarInput" hidden accept="image/*">
    <img id="userAvatar" style="cursor:pointer">
    <span id="gear" style="cursor:pointer;font-size:20px">⚙️</span>
  </div>
</header>

<div id="chat"></div>

<div id="inputWrap">
  <input id="userInput" placeholder="Type here…">
  <button id="sendBtn">Send</button>
</div>

<!-- SETTINGS -->
<div class="modal" id="settings">
  <div class="modal-box">
    <h3>Settings</h3>
    <label>Kids Mode <input type="checkbox"></label>
    <label>Private Mode <input type="checkbox"></label>
    <label>
      Country
      <select>
        <option>Philippines</option>
        <option>International</option>
      </select>
    </label>
    <button onclick="clearChat()">Clear history</button><br><br>
    <button onclick="closeSettings()">Close</button>
  </div>
</div>

<script>
/* CORE */
let QA=null;
let currentState=null;
let lang='en';
let started=false;

const chat=document.getElementById('chat');
const input=document.getElementById('userInput');

/* LOAD QA */
(async()=>{
  const res=await fetch('./qa.json');
  QA=await res.json();
})();

/* UTIL */
const norm=t=>t.toLowerCase().trim();
const isTL=t=>/(kumusta|hindi|mabigat|salamat|medyo|nga|ako|ka)/i.test(t);
const isGreeting=t=>/(hi|hello|hey|kumusta)/i.test(t);

function say(text,who){
  const d=document.createElement('div');
  d.className='msg '+who;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ROUTING */
function routeBinary(text){
  const t = norm(text);
  const s = QA.states[currentState];

  // OPTION A = positive / okay
  const optionAKeywords = [
    'ok','okay','fine','good',
    'ayos','maayos','okay lang'
  ];

  // OPTION B = not okay / heavy
  const optionBKeywords = [
    'not okay','hindi','hindi masyado','di okay',
    'mabigat','heavy','pagod','down','sad'
  ];

  if(optionAKeywords.some(k => t.includes(k))){
    return s.options[0].next;
  }

  if(optionBKeywords.some(k => t.includes(k))){
    return s.options[1].next;
  }

  return null;
}

/* SEND */
document.getElementById('sendBtn').onclick=()=>{
  const text=input.value.trim();
  if(!text||!QA) return;

  lang=isTL(text)?'tl':'en';
  say(text,'user');
  input.value='';

  // FIRST MESSAGE = GREETING
  if(!started && isGreeting(text)){
    currentState='friendliness_01';
    started=true;
    say(QA.states[currentState].text[lang],'bot');
    return;
  }

  // NORMAL FLOW
  if(!currentState) return;

  const next=routeBinary(text);
  if(next){
    currentState=next;
    say(QA.states[currentState].text[lang],'bot');
  }else{
    say(
      lang==='tl'
        ? 'Pumili ka lang sa dalawang nabanggit ko.'
        : 'Please choose between the two options I mentioned.',
      'bot'
    );
  }
};

/* SETTINGS + AVATAR */
const settings=document.getElementById('settings');
document.getElementById('gear').onclick=()=>settings.style.display='flex';
function closeSettings(){settings.style.display='none'}
settings.onclick=e=>{if(e.target===settings)closeSettings()}
function clearChat(){chat.innerHTML='';closeSettings()}

const userAvatar=document.getElementById('userAvatar');
const userAvatarInput=document.getElementById('userAvatarInput');
userAvatar.onclick=()=>userAvatarInput.click();
userAvatarInput.onchange=e=>{
  const f=e.target.files[0];
  if(f) userAvatar.src=URL.createObjectURL(f);
};
</script>

</body>
</html>
